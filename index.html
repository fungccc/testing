<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA Studio v10.0 - Omni Station</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.8/build/opensheetmusicdisplay.min.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-panel: rgba(18, 18, 20, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --neon-cyan: #00f2ff;
            --neon-purple: #bd00ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-orange: #ff9d00; /* Drone Color */
            
            --text-main: #ffffff;
            --text-mute: #888;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background: radial-gradient(circle at 50% 30%, #1a1a1a 0%, #000 80%);
            color: var(--text-main); font-family: "Inter", sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none;
        }

        /* --- TOP BAR --- */
        .top-bar {
            height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            z-index: 100; pointer-events: none; position: absolute; top:0; width:100%;
        }
        .top-left, .top-right { pointer-events: auto; display: flex; gap: 10px; align-items: center; }
        
        .brand-pill {
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 8px 16px; display: flex; align-items: center; gap: 8px;
        }
        .brand-logo { font-weight: 800; font-size: 0.9rem; letter-spacing: 2px; background: linear-gradient(90deg, #fff, var(--neon-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .indicator-dot { width:8px; height:8px; border-radius:50%; background:#333; transition:0.3s; }
        .indicator-dot.active { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }

        .icon-btn {
            width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            color: #ddd; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: 0.2s; backdrop-filter: blur(4px);
        }
        .icon-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }
        .icon-btn.active { border-color: var(--neon-cyan); color: var(--neon-cyan); background: rgba(0,242,255,0.1); }

        /* --- STAGE --- */
        .viewport-stage { flex: 1; position: relative; overflow: hidden; width: 100%; }
        #tunerCanvas { width: 100%; height: 100%; position: absolute; }
        #osmdContainer { 
            position: absolute; top: 70px; bottom: 90px; left: 2%; right: 2%;
            background: #fff; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            opacity: 0; pointer-events: none; transition: opacity 0.3s; overflow: auto;
        }
        .sheet-active #tunerCanvas { opacity: 0; }
        .sheet-active #osmdContainer { opacity: 1; pointer-events: auto; }

        /* --- HUD --- */
        .hud-capsule {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; pointer-events: none; z-index: 50; transition: 0.3s;
        }
        .sheet-active .hud-capsule { top: 20px; transform: translateX(-50%) scale(0.65); opacity: 0.9; }

        .note-ring {
            width: 140px; height: 140px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.3); transition: border-color 0.2s, box-shadow 0.2s;
        }
        /* Accuracy Colors */
        .note-ring.perfect { border-color: var(--neon-green); box-shadow: 0 0 40px rgba(0, 255, 157, 0.4); }
        .note-ring.good { border-color: #ffd700; } /* Gold */
        .note-ring.target { border-color: var(--neon-cyan); box-shadow: 0 0 30px rgba(0, 242, 255, 0.3); }

        .hud-note { font-size: 5rem; font-weight: 200; line-height: 1; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .hud-octave { font-size: 1.5rem; position: absolute; top: 30px; right: 25px; color: var(--text-mute); }
        .hud-data { display: flex; gap: 10px; margin-top: 10px; }
        .data-tag { background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 8px; font-size: 0.8rem; font-family: monospace; color: var(--text-mute); border: 1px solid var(--glass-border); }
        
        /* --- COMMAND DECK --- */
        .command-deck {
            background: var(--bg-panel); border-top: 1px solid var(--glass-border);
            padding: 12px 20px; z-index: 90; height: 90px;
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
        }
        .deck-left, .deck-right { display: flex; gap: 10px; align-items: center; }
        .deck-center { display: flex; gap: 12px; align-items: center; justify-content: center; }
        .deck-right { justify-content: flex-end; }

        .info-group { display: flex; flex-direction: column; cursor: pointer; }
        .info-label { font-size: 0.55rem; color: #666; letter-spacing: 1px; }
        .info-val { font-family: "Courier New", monospace; font-size: 1.1rem; color: var(--neon-cyan); font-weight: bold; }

        .transport-btn {
            width: 50px; height: 50px; border-radius: 18px; background: #222; border: 1px solid #333; color: #fff;
            font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .transport-btn:active { transform: scale(0.95); }
        .transport-btn.playing { background: rgba(255,0,85,0.2); color: var(--neon-pink); border-color: var(--neon-pink); }
        .transport-btn.recording { background: var(--neon-pink); color: #fff; animation: pulse 1.5s infinite; }
        
        /* A-B Loop Buttons */
        .loop-controls { display: flex; gap: 4px; background: #111; padding: 4px; border-radius: 12px; border: 1px solid #333; margin-right: 10px; }
        .loop-btn { 
            width: 32px; height: 32px; border-radius: 8px; border: none; background: transparent; color: #555; 
            font-size: 0.7rem; font-weight: bold; cursor: pointer; 
        }
        .loop-btn.set { color: var(--neon-cyan); background: rgba(0, 242, 255, 0.1); }
        .loop-btn.active { color: #000; background: var(--neon-cyan); }

        /* Track Toggles */
        .track-controls { display: flex; gap: 6px; background: #111; padding: 4px; border-radius: 20px; border: 1px solid #333; margin-right: 10px;}
        .track-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: transparent; color: #444; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        .track-btn.active#btnToggleMetro { color: var(--neon-cyan); text-shadow: 0 0 5px var(--neon-cyan); }
        .track-btn.active#btnToggleMelody { color: var(--neon-purple); text-shadow: 0 0 5px var(--neon-purple); }

        /* --- KEYBOARD DRAWER --- */
        .keyboard-drawer {
            background: #080808; border-top: 1px solid #222; overflow: hidden; height: 0; transition: height 0.3s;
            display: flex; flex-direction: column;
        }
        .keyboard-drawer.open { height: 140px; }
        
        .octave-scroller { display: flex; gap: 5px; padding: 8px; justify-content: center; background: #111; }
        .pill { font-size: 0.7rem; padding: 4px 10px; color: #666; border: 1px solid #333; border-radius: 12px; cursor: pointer; background: transparent; }
        .pill.active { background: rgba(0,242,255,0.15); color: var(--neon-cyan); border-color: var(--neon-cyan); }

        .keys-container { flex: 1; display: flex; justify-content: center; gap: 10px; padding-bottom: 10px; padding-top: 5px; }
        .key-group { display: flex; flex-direction: column; align-items: center; }
        .sharps { display: flex; gap: 10px; margin-bottom: -20px; z-index: 10; pointer-events: none; }
        .sharps .key { pointer-events: auto; }
        .naturals { display: flex; gap: 2px; }
        
        .key { cursor: pointer; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; font-weight: bold; border-radius: 0 0 4px 4px; user-select: none; }
        .key.natural { width: 38px; height: 70px; background: #eee; color: #333; border-bottom: 4px solid #ccc; font-size: 0.8rem; }
        .key.sharp { width: 28px; height: 45px; background: #222; color: #fff; border-bottom: 4px solid #000; font-size: 0.7rem; }
        
        /* Key States */
        .key:active, .key.pressed { transform: translateY(2px); border-bottom-width: 2px; }
        .key.active { background: var(--neon-cyan) !important; color: #000 !important; } /* Detected */
        .key.drone { background: var(--neon-orange) !important; color: #000 !important; box-shadow: 0 0 15px var(--neon-orange); animation: drone-pulse 2s infinite; } /* Drone Mode */
        @keyframes drone-pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 200; }
        .modal-content { max-width: 450px; margin: 40px auto; background: #151515; border: 1px solid var(--glass-border); padding: 25px; border-radius: 20px; height: 85vh; overflow-y: auto; }
        .setting-row { margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 8px; color: #aaa; font-size: 0.85rem; }
        input[type=range] { width: 100%; height: 4px; background: #333; -webkit-appearance: none; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; }
        
        .start-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); z-index:300; display:flex; justify-content:center; align-items:center; }
        #startBtn { padding: 15px 40px; border-radius: 40px; border: none; background: var(--neon-cyan); font-size: 1.2rem; font-weight: 800; cursor: pointer; box-shadow: 0 0 30px var(--neon-cyan); }

        .hidden-file { display: none; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,85,0.7); } 100% { box-shadow: 0 0 0 10px rgba(255,0,85,0); } }
    </style>
</head>
<body id="appBody">

    <nav class="top-bar">
        <div class="top-left">
            <button class="icon-btn" id="openSettings">‚öôÔ∏è</button>
            <div class="brand-pill">
                <span class="brand-logo">AURA v10</span>
                <div class="indicator-dot" id="midiStatus" title="MIDI"></div>
            </div>
        </div>
        <div class="top-right">
            <div id="backingTrackStatus" class="brand-pill" style="display:none; margin-right:10px; border-color:var(--neon-purple);">
                <span style="color:var(--neon-purple); font-size:0.7rem;">‚ô™ AUDIO</span>
                <span onclick="clearBackingTrack()" style="cursor:pointer; margin-left:8px;">‚úï</span>
            </div>
            <button class="icon-btn primary" id="btnExportXML" style="display:none;">XML</button>
            <button class="icon-btn primary" id="btnExportWAV" style="display:none;">WAV</button>
            <button class="icon-btn" id="btnLoad">üìÇ</button>
            <input type="file" id="fileInput" class="hidden-file" accept=".xml,.mxl,.musicxml,.wav,.mp3">
        </div>
    </nav>

    <div class="viewport-stage" id="mainStage">
        <canvas id="tunerCanvas"></canvas>
        <div id="osmdContainer"></div>
        
        <div class="hud-capsule">
            <div class="note-ring" id="noteRing">
                <span id="note" class="hud-note">-</span>
                <span id="octave" class="hud-octave"></span>
            </div>
            <div class="hud-data">
                <div class="data-tag"><span id="hz">0.0</span> Hz</div>
                <div class="data-tag"><span id="cents">0</span> ¬¢</div>
            </div>
        </div>

        <div class="start-overlay" id="startOverlay"><button id="startBtn">INITIALIZE SYSTEM</button></div>
        <div id="countInOverlay" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:10rem; color:var(--neon-cyan); opacity:0; pointer-events:none; z-index:150;"></div>
        
        <div style="position:absolute; bottom:20px; right:20px; display:flex; flex-direction:column; gap:8px;">
            <button class="icon-btn" onclick="zoomOSMD(1.1)">+</button>
            <button class="icon-btn" onclick="zoomOSMD(0.9)">-</button>
        </div>
    </div>

    <div class="command-deck">
        <div class="deck-left">
            <div class="info-group" id="btnTempo">
                <span class="info-label">TEMPO</span>
                <span class="info-val" id="bpmDisplay">120</span>
            </div>
            <div class="info-group" style="margin-left:15px">
                <span class="info-label">RATE</span>
                <span class="info-val" id="rateDisplay">1.0x</span>
            </div>
        </div>

        <div class="deck-center">
            <div class="loop-controls">
                <button class="loop-btn" id="btnLoopA" title="Set Start">A</button>
                <button class="loop-btn" id="btnLoopB" title="Set End">B</button>
                <button class="loop-btn" id="btnLoopToggle" title="Loop On/Off">‚Üª</button>
            </div>

            <div class="track-controls">
                <button class="track-btn active" id="btnToggleMetro">ü•Å</button>
                <button class="track-btn active" id="btnToggleMelody">üéπ</button>
            </div>

            <div style="width:1px; height:30px; background:#333; margin:0 10px;"></div>

            <button class="transport-btn" id="btnStop" disabled>‚ñ†</button>
            <button class="transport-btn" id="btnPlay" disabled>‚ñ∂</button>
            <button class="transport-btn" id="btnRec" style="color:var(--neon-pink);">‚óè</button>
        </div>

        <div class="deck-right">
            <button class="icon-btn" id="btnView">üëÅÔ∏è</button>
            <button class="icon-btn" onclick="toggleKeyboard()" style="margin-left:8px;">üéπ</button>
        </div>
    </div>

    <div class="keyboard-drawer" id="keyboardDrawer">
        <div class="octave-scroller" id="octaveScroller">
            <button class="pill" data-oct="2">C2</button>
            <button class="pill" data-oct="3">C3</button>
            <button class="pill active" data-oct="4">C4</button>
            <button class="pill" data-oct="5">C5</button>
            <button class="pill" data-oct="6">C6</button>
            <span style="color:#444; font-size:0.6rem; align-self:center; margin-left:10px;">TIP: Click Key to Toggle Drone</span>
        </div>
        <div class="keys-container">
            <div class="key-group">
                <div class="sharps">
                    <div class="key sharp" data-note="C#"></div><div class="key sharp" data-note="D#"></div>
                </div>
                <div class="naturals">
                    <div class="key natural" data-note="C">C</div><div class="key natural" data-note="D">D</div><div class="key natural" data-note="E">E</div>
                </div>
            </div>
            <div class="key-group">
                <div class="sharps">
                    <div class="key sharp" data-note="F#"></div><div class="key sharp" data-note="G#"></div><div class="key sharp" data-note="A#"></div>
                </div>
                <div class="naturals">
                    <div class="key natural" data-note="F">F</div><div class="key natural" data-note="G">G</div><div class="key natural" data-note="A">A</div><div class="key natural" data-note="B">B</div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 style="color:#fff; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px; display:flex; justify-content:space-between;">
                SYSTEM CONFIG <span id="closeSettings" style="cursor:pointer;">&times;</span>
            </h2>

            <div class="setting-row">
                <div class="label-row"><span>üéº Transpose (Semitones)</span> <span id="transDisplay" style="color:var(--neon-cyan)">0</span></div>
                <div style="display:flex; gap:10px;">
                    <button class="pill" onclick="setTranspose(-1)">-1</button>
                    <button class="pill" onclick="setTranspose(0)">Reset</button>
                    <button class="pill" onclick="setTranspose(1)">+1</button>
                </div>
            </div>

            <div class="setting-row">
                <div class="label-row"><span>üîä Space Reverb</span> <span id="reverbStatus" style="color:#888">Off</span></div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="pill" id="btnReverbToggle" onclick="toggleReverb()">Enable Reverb</button>
                    <input type="range" id="reverbMix" min="0" max="1" step="0.1" value="0.4" style="flex:1" disabled>
                </div>
            </div>

            <div class="setting-row">
                <div class="label-row"><span>Master Volume</span> <span id="volValueDisplay">150%</span></div>
                <input type="range" id="volSlider" min="0.1" max="2.0" step="0.1" value="1.5">
            </div>
            <div class="setting-row">
                <div class="label-row"><span>A4 Reference</span> <span id="a4Display">440 Hz</span></div>
                <input type="range" id="a4Slider" min="430" max="450" step="1" value="440">
            </div>
            <div class="setting-row">
                <div class="label-row"><span>Target Lock (Visual)</span></div>
                <input type="checkbox" id="targetModeToggle"> <span style="font-size:0.8rem; color:#888;">Enable</span>
                <select id="targetNoteSelect" style="background:#000; color:#fff; border:1px solid #333; padding:5px; margin-top:5px; width:100%;" disabled></select>
            </div>
        </div>
    </div>

    <div id="tempoModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--neon-cyan); margin-bottom:20px;">RHYTHM ENGINE <span id="closeTempo" style="float:right; cursor:pointer;">&times;</span></h2>
            
            <div class="setting-row">
                <div class="label-row"><span>Metronome</span> <span id="sigDisplay">4/4</span></div>
                <input type="checkbox" id="metroToggle"> Enable Click
            </div>
            <div class="setting-row">
                <div class="label-row"><span>Count-In</span></div>
                <input type="checkbox" id="countInToggle"> Pre-roll 1 Bar
            </div>

            <div class="setting-row">
                <div class="label-row"><span>Rate (0.1x - 10.0x)</span> <span id="origBpmDisplay">Ref: 120</span></div>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="pill" onclick="setSpeed(0.5)">0.5x</button>
                    <button class="pill" onclick="setSpeed(1.0)">1.0x</button>
                    <button class="pill" onclick="setSpeed(2.0)">2.0x</button>
                    <button class="pill" onclick="setSpeed(5.0)">5.0x</button>
                    <button class="pill" onclick="setSpeed(10.0)">Max</button>
                </div>
                <input type="range" id="rateSlider" min="0.1" max="10.0" step="0.1" value="1.0">
            </div>

            <div class="setting-row">
                <div class="label-row"><span>BPM</span></div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="pill" onclick="adjustBPM(-1)">-</button>
                    <input type="range" id="bpmSlider" min="20" max="999" step="1" value="120">
                    <button class="pill" onclick="adjustBPM(1)">+</button>
                </div>
            </div>
        </div>
    </div>

       <script>
        document.addEventListener('DOMContentLoaded', () => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
            let analyser, micSource, gainNode, dataArray, mediaStream;
            let masterGain, reverbNode, reverbGain; 
            let toneOsc = null, toneGain = null;
            let droneOsc = null, droneGain = null;
            let isRunning = false;
            
            // Reverb Impulse Response
            function createImpulseResponse(duration, decay, reverse) {
                const sampleRate = audioCtx.sampleRate;
                const length = sampleRate * duration;
                const impulse = audioCtx.createBuffer(2, length, sampleRate);
                const left = impulse.getChannelData(0);
                const right = impulse.getChannelData(1);
                for (let i = 0; i < length; i++) {
                    const n = reverse ? length - i : i;
                    left[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
                    right[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
                }
                return impulse;
            }

            // Init Audio Graph
            masterGain = audioCtx.createGain(); masterGain.gain.value = 1.0;
            reverbNode = audioCtx.createConvolver();
            reverbGain = audioCtx.createGain(); reverbGain.gain.value = 0.0;
            try { reverbNode.buffer = createImpulseResponse(2.0, 2.0, false); } catch(e){ console.warn("Reverb gen failed", e); }
            
            masterGain.connect(audioCtx.destination);
            masterGain.connect(reverbNode);
            reverbNode.connect(reverbGain);
            reverbGain.connect(audioCtx.destination);

            let osmd = null;
            let isSheetMode = false;
            let lastParsedDoc = null;

            // STATES
            let originalBPM = 120;
            let playbackSpeed = 1.0;
            let isMetroEnabled = false;
            let isMelodyEnabled = true;
            let isCountInEnabled = false;
            let transposeSemitones = 0;
            let currentBeatsPerMeasure = 4;
            let currentBeatType = 4;
            
            // Loop State
            let loopA = null; 
            let loopB = null;
            let isLoopActive = false;

            // Recorder & MIDI
            let mediaRecorder = null; let audioChunks = []; let wavBlob = null; let isRecording = false;
            let recordedNotes = []; let currentNoteEvent = null; let noteStartTime = 0;
            
            // Backing Track
            let backingBuffer = null; let backingSource = null; let backingGain = null;

            // [FIX] Complete UI Object
            const ui = {
                hz: document.getElementById('hz'), note: document.getElementById('note'), oct: document.getElementById('octave'), cents: document.getElementById('cents'),
                noteRing: document.getElementById('noteRing'),
                btnPlay: document.getElementById('btnPlay'), btnStop: document.getElementById('btnStop'),
                btnRec: document.getElementById('btnRec'), 
                startBtn: document.getElementById('startBtn'), // Fixed missing ID
                btnLoad: document.getElementById('btnLoad'), // Fixed missing ID
                btnExportXML: document.getElementById('btnExportXML'),
                btnExportWAV: document.getElementById('btnExportWAV'),
                btnLoopA: document.getElementById('btnLoopA'), btnLoopB: document.getElementById('btnLoopB'), btnLoopToggle: document.getElementById('btnLoopToggle'),
                rateSlider: document.getElementById('rateSlider'), bpmSlider: document.getElementById('bpmSlider'),
                transDisplay: document.getElementById('transDisplay'),
                reverbToggle: document.getElementById('btnReverbToggle'), reverbMix: document.getElementById('reverbMix'),
                keys: document.querySelectorAll('.key'),
                midiStatus: document.getElementById('midiStatus'),
                fileInput: document.getElementById('fileInput')
            };

            // === MIDI SUPPORT RESTORED ===
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess().then(onMIDISuccess, () => console.log("MIDI fail"));
            }
            function onMIDISuccess(midiAccess) {
                for (let input of midiAccess.inputs.values()) { input.onmidimessage = onMIDIMessage; }
                midiAccess.onstatechange = (e) => {
                    if(e.port.type === 'input' && e.port.state === 'connected') ui.midiStatus.classList.add('active');
                    else if(midiAccess.inputs.size === 0) ui.midiStatus.classList.remove('active');
                };
                if(midiAccess.inputs.size > 0) ui.midiStatus.classList.add('active');
            }
            function onMIDIMessage(event) {
                const [cmd, note, velocity] = event.data;
                const noteNameIndex = note % 12;
                const octave = Math.floor(note / 12) - 1;
                const noteName = notes[noteNameIndex];
                
                if (cmd === 144 && velocity > 0) { // Note On
                    const key = document.querySelector(`.key[data-note="${noteName}"]`);
                    if(key) key.classList.add('active');
                    
                    // Synthesize
                    const freq = 440 * Math.pow(2, (note - 69) / 12);
                    playTone(freq, 0, noteName, true); // Sustained
                    
                    if(isRecording) processRecording(noteName, octave);
                } else if (cmd === 128 || (cmd === 144 && velocity === 0)) { // Note Off
                    const key = document.querySelector(`.key[data-note="${noteName}"]`);
                    if(key) key.classList.remove('active');
                    stopTone(); 
                }
            }

            // === SETTINGS HANDLERS ===
            window.setTranspose = (delta) => {
                if (delta === 0) transposeSemitones = 0; else transposeSemitones += delta;
                ui.transDisplay.textContent = (transposeSemitones > 0 ? "+" : "") + transposeSemitones;
                if(osmd) { osmd.Sheet.Transpose = transposeSemitones; osmd.updateGraphic(); osmd.render(); }
            };

            let isReverbOn = false;
            window.toggleReverb = () => {
                isReverbOn = !isReverbOn;
                reverbGain.gain.setTargetAtTime(isReverbOn ? parseFloat(ui.reverbMix.value) : 0, audioCtx.currentTime, 0.1);
                ui.reverbToggle.textContent = isReverbOn ? "Disable Reverb" : "Enable Reverb";
                ui.reverbToggle.classList.toggle('active', isReverbOn);
                ui.reverbMix.disabled = !isReverbOn;
                document.getElementById('reverbStatus').textContent = isReverbOn ? "On" : "Off";
            };
            ui.reverbMix.oninput = (e) => { if(isReverbOn) reverbGain.gain.value = e.target.value; };

            // === LOOP HANDLERS ===
            ui.btnLoopA.onclick = () => {
                loopA = playbackManager.currentScoreTime;
                ui.btnLoopA.classList.add('set');
                alert("Loop Start (A) Set: " + loopA.toFixed(2) + "s");
            };
            ui.btnLoopB.onclick = () => {
                loopB = playbackManager.currentScoreTime;
                ui.btnLoopB.classList.add('set');
                alert("Loop End (B) Set: " + loopB.toFixed(2) + "s");
            };
            ui.btnLoopToggle.onclick = () => {
                if (loopA !== null && loopB !== null && loopB > loopA) {
                    isLoopActive = !isLoopActive;
                    ui.btnLoopToggle.classList.toggle('active', isLoopActive);
                } else { alert("Please set valid A and B points first."); }
            };

            // === TRACK TOGGLES ===
            document.getElementById('btnToggleMetro').onclick = function() {
                isMetroEnabled = !isMetroEnabled; this.classList.toggle('active', isMetroEnabled);
                document.getElementById('metroToggle').checked = isMetroEnabled;
            };
            document.getElementById('btnToggleMelody').onclick = function() {
                isMelodyEnabled = !isMelodyEnabled; this.classList.toggle('active', isMelodyEnabled);
            };

            // === RECORDER LOGIC RESTORED ===
            ui.btnRec.onclick = () => {
                isRecording = !isRecording;
                if (isRecording) { 
                    recordedNotes = []; currentNoteEvent = null; 
                    ui.btnRec.classList.add('recording'); 
                    ui.btnExportXML.style.display = 'none'; ui.btnExportWAV.style.display = 'none';
                    if (mediaStream) {
                        audioChunks = [];
                        mediaRecorder = new MediaRecorder(mediaStream);
                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                        mediaRecorder.start();
                    }
                } else { 
                    if(currentNoteEvent) recordedNotes.push({...currentNoteEvent, duration: Date.now()-noteStartTime}); 
                    ui.btnRec.classList.remove('recording'); 
                    if(recordedNotes.length) ui.btnExportXML.style.display = 'inline-flex';
                    if (mediaRecorder && mediaRecorder.state !== "inactive") {
                        mediaRecorder.stop();
                        mediaRecorder.onstop = () => {
                            wavBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            ui.btnExportWAV.style.display = 'inline-flex';
                        };
                    }
                }
            };
            
            function processRecording(detectedNote, detectedOctave) {
                const now = Date.now();
                if (!detectedNote) {
                    if (currentNoteEvent) { recordedNotes.push({...currentNoteEvent, duration: now - noteStartTime}); currentNoteEvent = null; }
                    return;
                }
                if (currentNoteEvent && detectedNote === currentNoteEvent.note && detectedOctave === currentNoteEvent.octave) return;
                if (currentNoteEvent) { recordedNotes.push({...currentNoteEvent, duration: now - noteStartTime}); }
                currentNoteEvent = {note: detectedNote, octave: detectedOctave}; noteStartTime = now;
            }

            ui.btnExportXML.onclick = () => {
                let x = `<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 4.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd"><score-partwise version="4.0"><part-list><score-part id="P1"><part-name>Rec</part-name></score-part></part-list><part id="P1"><measure number="1"><attributes><divisions>1000</divisions></attributes>`;
                recordedNotes.forEach(n=>{ let s=n.note[0], a=n.note.includes('#'); x+=`<note><pitch><step>${s}</step>${a?'<alter>1</alter>':''}<octave>${n.octave}</octave></pitch><duration>${n.duration}</duration><type>whole</type></note>`; });
                x+=`</measure></part></score-partwise>`;
                const blob = new Blob([x], { type: 'text/xml' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `aura_rec_${Date.now()}.musicxml`; a.click();
            };
            ui.btnExportWAV.onclick = () => {
                if (!wavBlob) return;
                const a = document.createElement('a'); a.href = URL.createObjectURL(wavBlob); a.download = `aura_rec_${Date.now()}.wav`; a.click();
            };

            // === PLAYBACK MANAGER ===
            const playbackManager = {
                timeouts: [], isPlaying: false, isPaused: false, currentScoreTime: 0,
                scoreAnchor: 0, audioAnchor: 0,

                clearTimers: function() { this.timeouts.forEach(id => clearTimeout(id)); this.timeouts = []; },
                
                play: function(xmlDoc, startOffset = 0) {
                    if(this.isPaused && startOffset===0) {
                        audioCtx.resume(); this.isPaused=false; this.isPlaying=true;
                        ui.btnPlay.textContent = "‚è∏"; ui.btnPlay.classList.add('playing');
                    } else {
                        this.clearTimers();
                        if (isCountInEnabled && startOffset === 0 && !this.isCountingIn) { this.startCountIn(xmlDoc); return; }
                        this.isPlaying = true; this.isPaused = false; this.isCountingIn = false;
                        this.scoreAnchor = startOffset; this.audioAnchor = audioCtx.currentTime;
                        ui.btnPlay.textContent = "‚è∏"; ui.btnPlay.classList.add('playing');
                        
                        // Backing Track
                        if (backingBuffer) {
                            if (backingSource) try{backingSource.stop()}catch(e){};
                            backingSource = audioCtx.createBufferSource();
                            backingSource.buffer = backingBuffer;
                            backingSource.playbackRate.value = playbackSpeed;
                            backingGain = audioCtx.createGain(); backingGain.gain.value = 1.5;
                            backingSource.connect(backingGain); backingGain.connect(masterGain); 
                            if(analyser) backingGain.connect(analyser);
                            backingSource.start(0, startOffset);
                        }

                        if(xmlDoc) playMusicXML(xmlDoc, startOffset);
                    }
                },

                startCountIn: function(xmlDoc) {
                    this.isCountingIn = true; ui.btnPlay.disabled = true;
                    const el = document.getElementById('countInOverlay'); el.style.opacity = 1;
                    let secPerBeat = (60/originalBPM) / playbackSpeed;
                    if(currentBeatType===8) secPerBeat*=0.5;

                    for(let i=0; i<currentBeatsPerMeasure; i++) {
                        const t = setTimeout(() => {
                            el.textContent = currentBeatsPerMeasure - i;
                            playClick(i===0);
                        }, i * secPerBeat * 1000);
                        this.timeouts.push(t);
                    }
                    const finalT = setTimeout(() => {
                        el.style.opacity = 0; ui.btnPlay.disabled = false; this.isCountingIn = false;
                        this.play(xmlDoc, 0);
                    }, currentBeatsPerMeasure * secPerBeat * 1000);
                    this.timeouts.push(finalT);
                },

                stop: function() {
                    this.clearTimers(); this.isPlaying = false; this.isPaused = false;
                    this.scoreAnchor = 0; this.audioAnchor = 0; this.currentScoreTime = 0;
                    ui.btnPlay.textContent = "‚ñ∂"; ui.btnPlay.classList.remove('playing');
                    if (backingSource) try{backingSource.stop()}catch(e){};
                    if (osmd && osmd.cursor) osmd.cursor.reset();
                    document.querySelectorAll('.key.pressed').forEach(k=>k.classList.remove('pressed'));
                }
            };

            // CORE ENGINE
            function playMusicXML(doc, startOffset) {
                let divisions = 480;
                const divTag = doc.querySelector("divisions");
                if (divTag) divisions = parseFloat(divTag.textContent);

                let secPerBeat = (60 / originalBPM) / playbackSpeed;
                const startTimeRef = audioCtx.currentTime + 0.1;
                
                // Metronome
                let currentBeatScore = Math.floor(startOffset / secPerBeat) * secPerBeat;
                let maxTime = startOffset + 300; 
                while (currentBeatScore < maxTime) {
                    if (currentBeatScore >= startOffset) {
                        const delay = (currentBeatScore - startOffset) / playbackSpeed;
                        const beatIndex = Math.round(currentBeatScore / secPerBeat);
                        const isStrong = (beatIndex % currentBeatsPerMeasure === 0);
                        const t = setTimeout(() => { if (playbackManager.isPlaying) playClick(isStrong); }, delay * 1000);
                        playbackManager.timeouts.push(t);
                    }
                    currentBeatScore += secPerBeat;
                }

                // Notes
                const parts = doc.querySelectorAll("part");
                let maxGlobalTime = 0;
                let isFirstNote = true;

                parts.forEach((part, idx) => {
                    let currentTime = 0;
                    const measures = part.querySelectorAll("measure");
                    measures.forEach((m, mIdx) => {
                        let mCursor = 0;
                        m.childNodes.forEach(node => {
                            if (node.tagName === "note") {
                                const dur = parseFloat(node.querySelector("duration")?.textContent || 0);
                                const durSec = (dur/divisions) * (60/originalBPM);
                                const noteStart = currentTime + mCursor;
                                
                                if (node.querySelector("chord")) { } else { mCursor += durSec; }

                                if (noteStart >= startOffset) {
                                    const delay = (noteStart - startOffset) / playbackSpeed;
                                    const realDur = durSec / playbackSpeed;

                                    if (idx === 0 && !node.querySelector("chord")) {
                                        const ct = setTimeout(() => {
                                            if (playbackManager.isPlaying && osmd.cursor) {
                                                playbackManager.currentScoreTime = noteStart;
                                                
                                                if (isLoopActive && noteStart >= loopB) {
                                                    playbackManager.stop();
                                                    playbackManager.play(lastParsedDoc, loopA);
                                                    return;
                                                }

                                                if (isFirstNote && startOffset === 0) { osmd.cursor.show(); isFirstNote = false; }
                                                else { osmd.cursor.next(); }
                                                if (isSheetMode) osmd.cursor.cursorElement.scrollIntoView({behavior:"smooth", block:"nearest", inline:"center"});
                                            }
                                        }, delay * 1000);
                                        playbackManager.timeouts.push(ct);
                                    }

                                    if (isMelodyEnabled && !node.querySelector("rest")) {
                                        const step = node.querySelector("step")?.textContent;
                                        const oct = node.querySelector("octave")?.textContent;
                                        const alt = node.querySelector("alter")?.textContent;
                                        if (step && oct) {
                                            let nn = step + (alt === "1" ? "#" : "");
                                            if(alt==="-1") nn = step==="B"?"A#":step==="E"?"D#":"G#";
                                            
                                            // Transpose
                                            let baseMidi = (parseInt(oct)+1)*12 + ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(nn);
                                            let finalMidi = baseMidi + transposeSemitones;
                                            let freq = 440 * Math.pow(2, (finalMidi - 69) / 12);
                                            
                                            const st = setTimeout(() => {
                                                if (playbackManager.isPlaying) {
                                                    playTone(freq, realDur, nn);
                                                }
                                            }, delay * 1000);
                                            playbackManager.timeouts.push(st);
                                        }
                                    }
                                }
                                maxGlobalTime = Math.max(maxGlobalTime, noteStart + durSec);
                            }
                            else if (node.tagName === "backup") { const d = parseFloat(node.querySelector("duration")?.textContent||0); mCursor -= (d/divisions)*(60/originalBPM); }
                            else if (node.tagName === "forward") { const d = parseFloat(node.querySelector("duration")?.textContent||0); mCursor += (d/divisions)*(60/originalBPM); }
                        });
                        currentTime += mCursor;
                    });
                });
            }

            function playTone(freq, dur, noteName, sustained = false) {
                if(sustained) {
                    // MIDI input sustained logic
                    if (toneOsc) stopTone();
                    toneOsc = audioCtx.createOscillator(); toneOsc.type = 'triangle';
                    toneOsc.frequency.value = freq;
                    toneGain = audioCtx.createGain(); toneGain.gain.value = 0.5;
                    toneOsc.connect(toneGain); toneGain.connect(masterGain);
                    toneOsc.start();
                    return;
                }
                // Playback short logic
                const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
                osc.type = 'triangle'; osc.frequency.value = freq;
                g.gain.setValueAtTime(0, audioCtx.currentTime);
                g.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);
                g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
                osc.connect(g); g.connect(masterGain); 
                osc.start(); osc.stop(audioCtx.currentTime + dur + 0.1);

                const k = document.querySelector(`.key[data-note="${noteName}"]`);
                if(k) { k.classList.add('pressed'); setTimeout(()=>k.classList.remove('pressed'), dur*1000); }
            }

            function stopTone() {
                if (toneOsc) { 
                    try { toneOsc.stop(); toneOsc.disconnect(); } catch(e){} 
                    toneOsc = null; 
                }
            }

            function playClick(strong) {
                if(!isMetroEnabled) return;
                const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
                osc.frequency.value = strong ? 1600 : 1200;
                g.gain.setValueAtTime(0.5, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                osc.connect(g); g.connect(masterGain);
                osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            }

            // DRONE MODE
            function toggleDrone(note, oct) {
                if (droneOsc) {
                    droneGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                    droneOsc.stop(audioCtx.currentTime + 0.1); droneOsc = null;
                    document.querySelectorAll('.key.drone').forEach(k=>k.classList.remove('drone'));
                    return; 
                }
                const noteNum = (oct + 1) * 12 + notes.indexOf(note);
                const freq = 440 * Math.pow(2, (noteNum - 69) / 12);
                
                droneOsc = audioCtx.createOscillator(); droneOsc.type = 'sawtooth'; droneOsc.frequency.value = freq;
                droneGain = audioCtx.createGain();
                const filter = audioCtx.createBiquadFilter(); filter.type = "lowpass"; filter.frequency.value = 800;
                droneGain.gain.setValueAtTime(0, audioCtx.currentTime);
                droneGain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.5);
                
                droneOsc.connect(filter); filter.connect(droneGain); droneGain.connect(masterGain);
                droneOsc.start();
                
                const k = document.querySelector(`.key[data-note="${note}"]`);
                if(k) k.classList.add('drone');
            }

            // UI INIT
            window.toggleKeyboard = () => document.getElementById('keyboardDrawer').classList.toggle('open');
            const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            
            ui.keys.forEach(k => {
                k.onmousedown = (e) => { 
                    e.preventDefault();
                    // Click key to toggle C3 Drone
                    const n = k.getAttribute('data-note');
                    toggleDrone(n, 3);
                };
            });

            // MIC & PITCH
            ui.startBtn.onclick = async () => {
                await audioCtx.resume();
                document.getElementById('startOverlay').style.display='none';
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false } });
                    analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
                    micSource = audioCtx.createMediaStreamSource(mediaStream);
                    micSource.connect(analyser);
                    dataArray = new Float32Array(analyser.fftSize);
                    isRunning = true; updatePitch();
                } catch(e) { alert("Mic Error: "+e); }
            };

            function updatePitch() {
                if(!isRunning) return;
                analyser.getFloatTimeDomainData(dataArray);
                const pitch = autoCorrelate(dataArray, audioCtx.sampleRate);
                
                if (pitch > 50) {
                    const noteFloat = 12 * (Math.log(pitch / 440) / Math.log(2)) + 69;
                    const noteInt = Math.round(noteFloat);
                    const cents = Math.floor((noteFloat - noteInt) * 100);
                    const nName = notes[noteInt % 12];
                    const oct = Math.floor(noteInt / 12) - 1;

                    ui.hz.textContent = pitch.toFixed(1);
                    ui.note.textContent = nName;
                    ui.oct.textContent = oct;
                    ui.cents.textContent = (cents>0?"+":"")+cents;

                    // Accuracy Ring
                    if (Math.abs(cents) < 10) ui.noteRing.className = "note-ring perfect";
                    else if (Math.abs(cents) < 25) ui.noteRing.className = "note-ring good";
                    else ui.noteRing.className = "note-ring";

                    document.querySelectorAll('.key.active').forEach(k=>k.classList.remove('active'));
                    const k = document.querySelector(`.key[data-note="${nName}"]`);
                    if(k) k.classList.add('active');
                } else { ui.noteRing.className = "note-ring"; }
                
                if(isSheetMode) drawTunerOnCanvas(); 
                requestAnimationFrame(updatePitch);
            }

            function drawTunerOnCanvas() {
                const cvs = document.getElementById('tunerCanvas');
                if(!cvs) return;
                // Basic visualizer logic can be added here if needed for sheet mode overlay
            }

            function autoCorrelate(buf, sr) {
                let size = buf.length; let rms = 0;
                for (let i=0;i<size;i++) rms += buf[i]*buf[i];
                if (Math.sqrt(rms/size) < 0.01) return -1;

                let r1=0, r2=size-1, thres=0.2;
                for (let i=0; i<size/2; i++) if (Math.abs(buf[i]) < thres) { r1=i; break; }
                for (let i=1; i<size/2; i++) if (Math.abs(buf[size-i]) < thres) { r2=size-i; break; }
                buf = buf.slice(r1, r2); size = buf.length;

                let c = new Array(size).fill(0);
                for (let i=0; i<size; i++) for (let j=0; j<size-i; j++) c[i] = c[i] + buf[j]*buf[j+i];
                let d=0; while (c[d]>c[d+1]) d++;
                let maxval=-1, maxpos=-1;
                for (let i=d; i<size; i++) if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
                return sr/maxpos;
            }

            // FILE & UI
            ui.btnLoad.onclick = () => ui.fileInput.click();
            ui.fileInput.onchange = (e) => {
                const f = e.target.files[0];
                if (f.name.endsWith('.wav') || f.name.endsWith('.mp3')) {
                    const r = new FileReader();
                    r.onload = async (ev) => {
                        backingBuffer = await audioCtx.decodeAudioData(ev.target.result);
                        document.getElementById('backingTrackStatus').style.display = 'flex';
                        ui.btnPlay.disabled=false; ui.btnStop.disabled=false;
                    };
                    r.readAsArrayBuffer(f);
                } else {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        const xml = ev.target.result;
                        lastParsedDoc = new DOMParser().parseFromString(xml, "text/xml");
                        const bpmTag = lastParsedDoc.querySelector("per-minute") || lastParsedDoc.querySelector("sound[tempo]");
                        if(bpmTag) originalBPM = parseFloat(bpmTag.textContent || bpmTag.getAttribute("tempo"));
                        document.getElementById('origBpmDisplay').textContent = "Ref: " + originalBPM;

                        if(!osmd) osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer", {autoResize:true, backend:"svg", drawingParameters:"compacttight"});
                        osmd.load(xml).then(() => { osmd.render(); ui.btnPlay.disabled=false; ui.btnStop.disabled=false; });
                    };
                    r.readAsText(f);
                }
            };
            
            window.setSpeed = (r) => { playbackSpeed = r; ui.rateSlider.value = r; document.getElementById('rateDisplay').textContent = r.toFixed(1)+"x"; };
            ui.rateSlider.oninput = (e) => setSpeed(parseFloat(e.target.value));
            
            document.getElementById('btnView').onclick = function() {
                isSheetMode = !isSheetMode;
                document.getElementById('mainStage').classList.toggle('sheet-active', isSheetMode);
                this.textContent = isSheetMode ? "üéº" : "üëÅÔ∏è";
            };

            // MODALS
            document.getElementById('openSettings').onclick = () => document.getElementById('settingsModal').style.display='block';
            document.getElementById('closeSettings').onclick = () => document.getElementById('settingsModal').style.display='none';
            document.getElementById('btnTempo').onclick = () => document.getElementById('tempoModal').style.display='block';
            document.getElementById('closeTempo').onclick = () => document.getElementById('tempoModal').style.display='none';
            ui.btnStop.onclick = () => playbackManager.stop();
            ui.btnPlay.onclick = () => isRunning ? (playbackManager.isPlaying ? playbackManager.stop() : playbackManager.play(lastParsedDoc)) : alert("Click Initialize First");
        });
    </script>

</body>
</html>
