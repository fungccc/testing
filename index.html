<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Web Tuner T1 - v8.0 Pro Glass Studio</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.8/build/opensheetmusicdisplay.min.js"></script>

    <style>
        :root {
            /* --- COLOR PALETTE: Studio Dark + Neon --- */
            --bg-base: #050505;
            --bg-gradient: radial-gradient(circle at 50% 30%, #1a1a1a 0%, #000000 100%);
            
            --glass-bg: rgba(30, 30, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-blur: blur(12px);
            
            --text-main: #e0e0e0;
            --text-dim: #888888;
            
            --neon-green: #00e676;
            --neon-red: #ff1744;
            --neon-blue: #2979ff;
            --neon-yellow: #ffea00;
            
            --btn-hover: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-base);
            background-image: var(--bg-gradient);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
        }
        
        /* --- HEADER: Glass Bar --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; 
            height: 60px; /* Slightly taller for pro feel */
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--glass-border);
            z-index: 50; flex-shrink: 0;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        
        .title { 
            font-weight: 700; letter-spacing: 2px; color: #fff; font-size: 0.9rem; text-transform: uppercase; 
            opacity: 0.8;
        }
        .title span { color: var(--neon-green); font-weight: 900; }

        /* --- BUTTONS: Modern Outline --- */
        .icon-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 40px; height: 40px; border-radius: 8px; /* Soft square */
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 1.1rem; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .icon-btn:hover { background: var(--btn-hover); border-color: rgba(255,255,255,0.3); }
        .icon-btn:active { transform: scale(0.92); }
        .icon-btn:disabled { opacity: 0.2; cursor: not-allowed; }

        /* Active States with Glow */
        .icon-btn.active { 
            color: var(--neon-yellow); 
            border-color: var(--neon-yellow); 
            box-shadow: 0 0 8px rgba(255, 234, 0, 0.2);
            background: rgba(255, 234, 0, 0.05);
        }

        /* Specific Actions */
        #btnRec { width: auto; padding: 0 12px; gap: 6px; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.5px;}
        #btnRec.recording { 
            background: rgba(255, 23, 68, 0.15); 
            color: var(--neon-red); 
            border-color: var(--neon-red); 
            box-shadow: 0 0 10px rgba(255, 23, 68, 0.3);
            animation: pulse-glow 2s infinite; 
        }
        
        #btnPlay.playing { 
            background: rgba(255, 23, 68, 0.1); 
            color: var(--neon-red); 
            border-color: var(--neon-red); 
        }
        #btnPlay.paused { 
            background: rgba(41, 121, 255, 0.1); 
            color: var(--neon-blue); 
            border-color: var(--neon-blue); 
            animation: border-blink 1.5s infinite; 
        }

        /* Loading / Export */
        #btnLoad, #btnExport { color: var(--neon-blue); }

        @keyframes pulse-glow { 0% { box-shadow: 0 0 5px rgba(255,23,68,0.2); } 50% { box-shadow: 0 0 15px rgba(255,23,68,0.6); } 100% { box-shadow: 0 0 5px rgba(255,23,68,0.2); } }
        @keyframes border-blink { 0% { border-color: var(--neon-blue); opacity:1; } 50% { border-color: transparent; opacity:0.7; } 100% { border-color: var(--neon-blue); opacity:1; } }
        
        .hidden-input { display: none; }
        .separator { width: 1px; height: 24px; background: var(--glass-border); margin: 0 4px; }

        /* --- READOUT: VFD Display Style --- */
        .readout {
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
            text-align: center; padding: 10px 0; 
            background: rgba(0,0,0,0.3); /* Slightly darker */
            z-index: 40; height: 90px; flex-shrink: 0;
            border-bottom: 1px solid var(--glass-border);
        }
        .hz-val { font-size: 1.1rem; color: var(--text-dim); font-family: "Courier New", monospace; letter-spacing: -0.5px; }
        .hz-label { font-size: 0.6rem; color: #555; display: block; letter-spacing: 2px; text-transform: uppercase; margin-top: 2px;}
        
        .note-container { display: flex; align-items: baseline; justify-content: center; width: 140px;}
        .note-display { 
            font-size: 5.5rem; font-weight: 300; line-height: 1; color: #fff; 
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .note-octave { font-size: 2.2rem; color: var(--text-dim); margin-left: 8px; font-weight: 300; }
        
        .cents-val { font-size: 1.1rem; color: var(--text-dim); font-family: "Courier New", monospace; }
        .target-mode-active .note-display { color: var(--neon-yellow); text-shadow: 0 0 25px rgba(255, 234, 0, 0.4); }

        /* --- MAIN STAGE --- */
        .main-stage { flex: 1; position: relative; overflow: hidden; }
        
        #tunerCanvas { 
            width: 100%; height: 100%; display: block; position: absolute; top: 0; left: 0; 
            z-index: 10; opacity: 0.9; /* Slight see-through for cool effect */
            transition: opacity 0.4s ease;
        }
        
        #osmdContainer {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            background: #fff; z-index: 5; 
            overflow: auto; padding-top: 20px; 
            visibility: hidden; scroll-behavior: smooth;
            /* Inner shadow for paper look */
            box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
        }

        .main-stage.sheet-mode #tunerCanvas { opacity: 0; pointer-events: none; }
        .main-stage.sheet-mode #osmdContainer { visibility: visible; z-index: 10; }
        
        /* Start Button - Floating Pill */
        .start-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 16px 40px; 
            background: rgba(0, 230, 118, 0.1);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-weight: 600; letter-spacing: 1px;
            border-radius: 50px; cursor: pointer;
            font-size: 1.1rem; z-index: 30; 
            backdrop-filter: blur(5px);
            box-shadow: 0 0 30px rgba(0, 230, 118, 0.2);
            transition: all 0.3s;
        }
        .start-btn:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 50px rgba(0, 230, 118, 0.6); }
        .main-stage.sheet-mode .start-btn { display: none !important; }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute; bottom: 25px; right: 25px; 
            display: none; flex-direction: column; gap: 12px; z-index: 50;
        }
        .main-stage.sheet-mode .zoom-controls { display: flex; }
        .zoom-btn {
            width: 44px; height: 44px; border-radius: 50%; 
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid var(--glass-border);
            color: white; font-size: 1.4rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }
        .zoom-btn:active { transform: scale(0.9); background: #000; border-color: #666; }

        /* --- KEYBOARD: Crystal Keys --- */
        .keyboard-area { 
            background: var(--glass-bg); 
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            padding: 15px 0 20px 0; 
            z-index: 40; 
            border-top: 1px solid var(--glass-border); 
            flex-shrink: 0; 
        }
        
        /* Octave Scroller */
        .octave-scroller { display: flex; overflow-x: auto; gap: 8px; padding: 0 20px 15px 20px; scrollbar-width: none; }
        .octave-scroller::-webkit-scrollbar { display: none; }
        .pill { 
            background: transparent; color: var(--text-dim); 
            padding: 6px 14px; border-radius: 20px; 
            font-size: 0.75rem; cursor: pointer; 
            border: 1px solid var(--glass-border); 
            flex-shrink: 0; letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .pill:hover { border-color: #666; color: #ccc; }
        .pill.active { 
            background: rgba(41, 121, 255, 0.15); 
            color: var(--neon-blue); 
            border-color: var(--neon-blue); 
            font-weight: 600;
            box-shadow: 0 0 10px rgba(41, 121, 255, 0.2);
        }
        
        /* Piano Keys */
        .keys-wrapper { padding: 0 10px; position: relative; }
        .keys-row { display: flex; justify-content: center; gap: 6px; }
        
        .key { 
            width: 42px; height: 60px; 
            background: linear-gradient(180deg, #333 0%, #222 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0 0 6px 6px; 
            display: flex; align-items: flex-end; justify-content: center; 
            font-weight: 600; color: #ccc; font-size: 0.9rem; padding-bottom: 8px; 
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.1s, background 0.1s, box-shadow 0.1s;
        }
        .key.sharp { 
            background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
            height: 40px; margin-bottom: 20px; 
            border-radius: 0 0 4px 4px; padding-bottom: 0; align-items: center; 
            z-index: 2; border-color: rgba(0,0,0,0.5);
        }
        
        /* Key Active States */
        .key.active { /* Mic Detect */
            background: var(--neon-green); color: #000; 
            box-shadow: 0 0 15px var(--neon-green); 
            border-color: var(--neon-green);
            transform: translateY(2px);
        }
        .key.pressed { /* Playback */
            background: var(--neon-blue); color: #fff; 
            box-shadow: 0 0 15px var(--neon-blue); 
            border-color: var(--neon-blue);
            transform: translateY(3px);
        }

        footer { 
            text-align: center; font-size: 0.65rem; color: #444; padding: 4px; 
            background: #000; letter-spacing: 1px; text-transform: uppercase;
        }

        /* --- MODALS: Glass Cards --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100; overflow-y: auto; }
        .modal-content { 
            max-width: 480px; margin: 60px auto; padding: 30px; 
            background: rgba(20, 20, 20, 0.9); 
            border: 1px solid var(--glass-border);
            border-radius: 16px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .close-btn { float: right; font-size: 1.8rem; cursor: pointer; color: #666; transition: 0.2s; }
        .close-btn:hover { color: #fff; }
        
        h2 { font-weight: 300; letter-spacing: 1px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }

        .mode-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .mode-card { 
            background: #111; border: 1px solid #333; padding: 20px; 
            cursor: pointer; border-radius: 10px; transition: all 0.2s;
        }
        .mode-card:hover { border-color: #555; background: #151515; }
        .mode-card.selected { 
            border-color: var(--neon-green); 
            background: rgba(0, 230, 118, 0.05); 
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.1);
        }
        
        .setting-group { margin-top: 30px; }
        .setting-label { display: flex; justify-content: space-between; color: #ccc; margin-bottom: 10px; font-size: 0.9rem; font-weight: 500; }
        
        /* Modern Sliders */
        .slider-container { display: flex; align-items: center; gap: 15px; }
        input[type=range] { 
            flex: 1; height: 4px; background: #333; border-radius: 2px; outline: none; -webkit-appearance: none; 
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 18px; height: 18px; 
            background: #fff; border-radius: 50%; cursor: pointer; 
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.2); }
        
        /* Modern Toggle */
        .toggle-switch { display: flex; align-items: center; gap: 12px; cursor: pointer; margin-top: 10px; }
        .toggle-switch input { display: none; }
        .slider { width: 44px; height: 24px; background: #333; border-radius: 24px; position: relative; transition: 0.3s; }
        .slider:before { content: ""; position: absolute; width: 18px; height: 18px; left: 3px; bottom: 3px; background: #888; border-radius: 50%; transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); }
        input:checked + .slider { background: var(--neon-yellow); }
        input:checked + .slider:before { transform: translateX(20px); background: #000; }
        
        .preset-btn-group { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .preset-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: 0.2s;}
        .preset-btn:hover { border-color: #fff; color: #fff; }
        
        select.dark-select { 
            background: #111; color: #fff; border: 1px solid #333; padding: 10px; 
            border-radius: 8px; width: 100%; margin-top: 10px; outline: none;
        }

        /* Tempo Modal Specifics */
        .tempo-presets { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; justify-content: center;}
        .tempo-btn { 
            flex:1; background: #222; border: 1px solid #444; color: #ddd; 
            border-radius: 6px; padding: 8px; font-size: 0.85rem; cursor: pointer; min-width: 50px;
            transition: 0.2s;
        }
        .tempo-btn:hover { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        .tempo-val-display { font-size: 1.4rem; font-weight: 700; color: var(--neon-yellow); font-family: "Courier New", monospace; }
        .micro-btn { 
            width: 32px; height: 32px; background: #333; border: 1px solid #555; 
            color: white; border-radius: 50%; cursor: pointer; font-weight: bold; 
            display: flex; align-items: center; justify-content: center;
        }
        .micro-btn:active { background: #555; }

    </style>
</head>
<body id="appBody">

    <header>
        <div class="header-left">
            <button class="icon-btn" id="openSettings" title="Settings">‚öôÔ∏è</button>
            <div class="title">TUNER <span>T1</span></div>
        </div>
        <div class="header-right">
            <button class="icon-btn" id="btnTempo" title="Tempo Control" style="margin-right: 5px;">‚è±Ô∏è</button>
            <button class="icon-btn" id="btnRec" title="Record">‚óè REC</button>
            <button class="icon-btn" id="btnExport" title="Save XML" style="display:none;">‚¨á</button>
            <div class="separator"></div>
            <button class="icon-btn" id="btnLoad" title="Load MusicXML">üìÇ</button>
            <button class="icon-btn" id="btnView" title="Toggle View">üëÅÔ∏è</button>
            <button class="icon-btn" id="btnStop" title="Stop/Reset" disabled>‚ñ†</button>
            <button class="icon-btn" id="btnPlay" title="Play/Pause" disabled>‚ñ∂</button>
            <input type="file" id="fileInput" class="hidden-input" accept="*">
        </div>
    </header>

    <div class="readout">
        <div><span id="hz" class="hz-val">0.0</span> <span class="hz-label">HZ</span></div>
        <div class="note-container"><span id="note" class="note-display">-</span><span id="octave" class="note-octave"></span></div>
        <div><span id="cents" class="cents-val">0.0</span> <span class="hz-label">CENTS</span></div>
    </div>

    <div class="main-stage" id="mainStage">
        <canvas id="tunerCanvas"></canvas>
        <div id="osmdContainer"></div>
        <button class="start-btn" id="startBtn">‚ö° ÂïüÂãï (START)</button>
        <div class="zoom-controls" id="zoomControls">
            <button class="zoom-btn" onclick="zoomOSMD(1.2)">+</button>
            <button class="zoom-btn" onclick="zoomOSMD(0.8)">-</button>
        </div>
    </div>

    <div class="keyboard-area">
        <div class="octave-scroller" id="octaveScroller">
            <div class="pill" data-oct="1">-3 (C1)</div>
            <div class="pill" data-oct="2">-2 (C2)</div>
            <div class="pill" data-oct="3">-1 (C3)</div>
            <div class="pill active" data-oct="4">Default (C4)</div>
            <div class="pill" data-oct="5">+1 (C5)</div>
            <div class="pill" data-oct="6">+2 (C6)</div>
            <div class="pill" data-oct="7">+3 (C7)</div>
        </div>
        <div class="keys-wrapper">
            <div class="keys-row" style="margin-bottom: -20px; padding-left: 20px;">
                <div class="key sharp" data-note="C#">C#</div><div class="key sharp" data-note="D#">D#</div>
                <div style="width: 46px; pointer-events: none;"></div>
                <div class="key sharp" data-note="F#">F#</div><div class="key sharp" data-note="G#">G#</div><div class="key sharp" data-note="A#">A#</div>
            </div>
            <div class="keys-row">
                <div class="key" data-note="C">C</div><div class="key" data-note="D">D</div><div class="key" data-note="E">E</div>
                <div class="key" data-note="F">F</div><div class="key" data-note="G">G</div><div class="key" data-note="A">A</div><div class="key" data-note="B">B</div>
            </div>
        </div>
    </div>
    
    <footer>Ë±êÁãÇÂá∫ÂìÅ ‚Ä¢ v8.0 Pro Glass Studio</footer>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeSettings">&times;</span>
            <h2 style="color:#fff;">Á≥ªÁµ±Ë®≠ÂÆö (Settings)</h2>
            <div class="mode-options">
                <div class="mode-card selected" onclick="setMode('turbo')" id="modeTurbo">
                    <strong style="color:#fff; font-size:1.1rem;">üéπ Ê•µÈÄüÊ®°Âºè</strong><br><small style="color:#888">‰ΩéÂª∂ÈÅ≤ (ÈÅ©ÂêàÈãºÁê¥/Âêâ‰ªñ)</small>
                </div>
                <div class="mode-card" onclick="setMode('bass')" id="modeBass">
                    <strong style="color:#fff; font-size:1.1rem;">üê¢ ‰ΩéÈü≥Ê®°Âºè</strong><br><small style="color:#888">È´òÁ≤æÊ∫ñ (ÈÅ©ÂêàË≤ùÊñØ)</small>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-label">üîä Èü≥Èáè (Vol) <span id="volValueDisplay" class="setting-val">150%</span></div>
                <div class="slider-container">
                    <span style="font-size:1.2rem; color:#666;">üîà</span>
                    <input type="range" id="volSlider" min="0.1" max="2.0" step="0.1" value="1.5">
                    <span style="font-size:1.2rem; color:#fff;">üîä</span>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-label">üéπ A4 Âü∫Ê∫ñÈü≥ <span id="a4Display" class="setting-val">440 Hz</span></div>
                <div class="slider-container">
                    <span style="color:#666; font-size:0.8rem;">430</span>
                    <input type="range" id="a4Slider" min="430" max="450" step="1" value="440">
                    <span style="color:#666; font-size:0.8rem;">450</span>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-label">üéØ ÁõÆÊ®ôÈü≥ÈéñÂÆö (Target Lock)</div>
                <label class="toggle-switch">
                    <input type="checkbox" id="targetModeToggle">
                    <div class="slider"></div>
                    <span style="font-size:0.85rem; color:#ccc;">ÂïüÁî®ÈéñÂÆö</span>
                </label>
                <select id="targetNoteSelect" class="dark-select" disabled></select>
            </div>
            <div class="setting-group">
                <div class="setting-label">üö™ Âô™Èü≥ÈñÄÊ™ª (Gate) <span id="gateDisplay" class="setting-val">Low</span></div>
                <div class="slider-container">
                    <input type="range" id="gateSlider" min="0.001" max="0.05" step="0.001" value="0.003">
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-label">üåä Á©©ÂÆöÂ∫¶ (Smooth) <span id="smoothDisplay" class="setting-val">Balanced</span></div>
                <div class="slider-container">
                    <input type="range" id="smoothSlider" min="0.1" max="0.9" step="0.1" value="0.3">
                </div>
            </div>
        </div>
    </div>

    <div id="tempoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeTempo">&times;</span>
            <h2 style="color:var(--neon-yellow);">‚è±Ô∏è ÈÄüÂ∫¶ÊéßÂà∂ (Tempo)</h2>
            <p style="color:#888; font-size:0.85rem; margin-bottom:25px; border-left: 2px solid var(--neon-yellow); padding-left: 10px;">
                ÂéüÂßãÈÄüÂ∫¶: <span id="origBpmDisplay" style="color:#fff; font-weight:bold;">120</span> BPM
            </p>

            <div class="tempo-section">
                <div class="setting-label">
                    <span>A. ÂÄçÁéá (Rate)</span>
                    <span id="rateDisplay" class="tempo-val-display">1.00x</span>
                </div>
                <div class="tempo-presets">
                    <button class="tempo-btn" onclick="setSpeed(0.5)">0.5x</button>
                    <button class="tempo-btn" onclick="setSpeed(0.75)">0.75x</button>
                    <button class="tempo-btn" onclick="setSpeed(1.0)">1.0x</button>
                    <button class="tempo-btn" onclick="setSpeed(1.25)">1.25x</button>
                    <button class="tempo-btn" onclick="setSpeed(1.5)">1.5x</button>
                </div>
                <div class="slider-container">
                    <button class="micro-btn" onclick="adjustRate(-0.02)">-</button>
                    <input type="range" id="rateSlider" min="0.2" max="2.0" step="0.01" value="1.0">
                    <button class="micro-btn" onclick="adjustRate(0.02)">+</button>
                </div>
            </div>

            <hr style="border:0; border-top:1px solid #333; margin:25px 0;">

            <div class="tempo-section">
                <div class="setting-label">
                    <span>B. ÁØÄÊãç (BPM)</span>
                    <span id="bpmDisplay" class="tempo-val-display">120 BPM</span>
                </div>
                <div class="tempo-presets" id="bpmPresets"></div>
                <div class="slider-container">
                    <button class="micro-btn" onclick="adjustBPM(-2)">-</button>
                    <input type="range" id="bpmSlider" min="20" max="240" step="1" value="120">
                    <button class="micro-btn" onclick="adjustBPM(2)">+</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        let analyser, micSource, gainNode, dataArray, mediaStream;
        let toneOsc = null, toneGain = null;
        let isRunning = false;
        let currentFFTSize = 2048; 
        let downsampleStep = 2;
        
        let osmd = null;
        let currentZoom = 1.0;
        let isSheetMode = false;
        let lastLoadedXML = null;

        // TEMPO STATE
        let originalBPM = 120;
        let playbackSpeed = 1.0;

        const defaultSettings = { a4: 440, gate: 0.003, smoothing: 0.3, targetMode: false, targetNoteIndex: 69 };
        let appSettings = { ...defaultSettings };
        const saved = localStorage.getItem('tuner_v6_settings');
        if (saved) { try { appSettings = { ...defaultSettings, ...JSON.parse(saved) }; } catch(e){} }
        function saveSettings() { localStorage.setItem('tuner_v6_settings', JSON.stringify(appSettings)); }

        let keyboardOctave = 4;
        let masterVolume = 1.5;
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        const ui = {
            hz: document.getElementById('hz'),
            note: document.getElementById('note'),
            oct: document.getElementById('octave'),
            cents: document.getElementById('cents'),
            keys: document.querySelectorAll('.key'),
            
            btnRec: document.getElementById('btnRec'),
            btnExport: document.getElementById('btnExport'),
            btnLoad: document.getElementById('btnLoad'),
            btnView: document.getElementById('btnView'),
            btnStop: document.getElementById('btnStop'),
            btnPlay: document.getElementById('btnPlay'),
            btnTempo: document.getElementById('btnTempo'),
            fileInput: document.getElementById('fileInput'),

            startBtn: document.getElementById('startBtn'),
            tunerCanvas: document.getElementById('tunerCanvas'),
            osmdContainer: document.getElementById('osmdContainer'),
            zoomControls: document.getElementById('zoomControls'),
            mainStage: document.getElementById('mainStage'),
            octavePills: document.querySelectorAll('.pill[data-oct]'),
            
            volSlider: document.getElementById('volSlider'),
            volDisplay: document.getElementById('volValueDisplay'),
            a4Slider: document.getElementById('a4Slider'),
            a4Display: document.getElementById('a4Display'),
            gateSlider: document.getElementById('gateSlider'),
            gateDisplay: document.getElementById('gateDisplay'),
            smoothSlider: document.getElementById('smoothSlider'),
            smoothDisplay: document.getElementById('smoothDisplay'),
            targetToggle: document.getElementById('targetModeToggle'),
            targetSelect: document.getElementById('targetNoteSelect'),
            appBody: document.getElementById('appBody'),

            // Tempo UI
            origBpmDisplay: document.getElementById('origBpmDisplay'),
            rateDisplay: document.getElementById('rateDisplay'),
            rateSlider: document.getElementById('rateSlider'),
            bpmDisplay: document.getElementById('bpmDisplay'),
            bpmSlider: document.getElementById('bpmSlider'),
            bpmPresets: document.getElementById('bpmPresets')
        };
        const canvas = document.getElementById('tunerCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });

        const historySize = 300; 
        const pitchHistory = new Array(historySize).fill(null);
        let lastNoteName = "";
        let currentCents = 0; 
        let isSignalActive = false;
        let lastValidCents = 0;
        let framesSinceLastSignal = 0;
        const SIGNAL_HOLD_FRAMES = 12; 
        let smoothedCents = 0;

        // === TEMPO LOGIC ===
        function updateTempoUI() {
            const currentBPM = Math.round(originalBPM * playbackSpeed);
            ui.rateSlider.value = playbackSpeed.toFixed(2);
            ui.rateDisplay.textContent = playbackSpeed.toFixed(2) + "x";
            ui.bpmSlider.min = Math.floor(originalBPM * 0.2);
            ui.bpmSlider.max = Math.floor(originalBPM * 2.0);
            ui.bpmSlider.value = currentBPM;
            ui.bpmDisplay.textContent = currentBPM + " BPM";
            ui.origBpmDisplay.textContent = originalBPM;
        }

        window.setSpeed = (rate) => {
            playbackSpeed = rate; updateTempoUI();
            if (playbackManager.isPlaying) playbackManager.play(lastLoadedXML);
        };
        window.setBPM = (targetBPM) => {
            playbackSpeed = targetBPM / originalBPM; updateTempoUI();
            if (playbackManager.isPlaying) playbackManager.play(lastLoadedXML);
        };
        ui.rateSlider.addEventListener('input', function() { playbackSpeed = parseFloat(this.value); updateTempoUI(); });
        ui.rateSlider.addEventListener('change', () => { if(playbackManager.isPlaying) playbackManager.play(lastLoadedXML); });
        ui.bpmSlider.addEventListener('input', function() { const target = parseInt(this.value); playbackSpeed = target / originalBPM; updateTempoUI(); });
        ui.bpmSlider.addEventListener('change', () => { if(playbackManager.isPlaying) playbackManager.play(lastLoadedXML); });
        window.adjustRate = (delta) => { let newRate = playbackSpeed + delta; if(newRate < 0.2) newRate = 0.2; if(newRate > 2.0) newRate = 2.0; setSpeed(newRate); };
        window.adjustBPM = (delta) => { const current = Math.round(originalBPM * playbackSpeed); setBPM(current + delta); };

        function setupBPMPresets() {
            ui.bpmPresets.innerHTML = "";
            [0.5, 0.75, 1.0, 1.25, 1.5].forEach(r => {
                const b = Math.round(originalBPM * r);
                const btn = document.createElement('button');
                btn.className = "tempo-btn"; btn.textContent = b; btn.onclick = () => setBPM(b);
                ui.bpmPresets.appendChild(btn);
            });
        }

        const playbackManager = {
            timeouts: [],
            isPlaying: false,
            isPaused: false,
            play: function(xmlContent) {
                if (this.isPaused) {
                    audioCtx.resume(); this.isPaused = false; this.isPlaying = true;
                    ui.btnPlay.textContent = "‚è∏"; ui.btnPlay.classList.remove('paused'); ui.btnPlay.classList.add('playing');
                } else {
                    if (!xmlContent) return;
                    this.stop(); playMusicXML(xmlContent);
                }
            },
            pause: function() {
                if (this.isPlaying) {
                    audioCtx.suspend(); this.isPlaying = false; this.isPaused = true;
                    ui.btnPlay.textContent = "‚ñ∂"; ui.btnPlay.classList.remove('playing'); ui.btnPlay.classList.add('paused');
                }
            },
            stop: function() {
                this.timeouts.forEach(id => clearTimeout(id)); this.timeouts = [];
                this.isPlaying = false; this.isPaused = false; audioCtx.resume();
                ui.btnPlay.textContent = "‚ñ∂"; ui.btnPlay.classList.remove('playing', 'paused');
                document.querySelectorAll('.key.pressed').forEach(k => k.classList.remove('pressed'));
                if (osmd && osmd.cursor) { osmd.cursor.reset(); try { osmd.cursor.update(); } catch(e){} }
            }
        };

        ui.btnLoad.onclick = () => ui.fileInput.click();
        
        ui.fileInput.onchange = async (e) => {
            const f = e.target.files[0]; if(!f) return;
            ui.btnLoad.style.color = "var(--neon-yellow)";
            try {
                let xmlContent = "";
                if (f.name.toLowerCase().endsWith('.mxl')) {
                    if (!window.JSZip) throw new Error("JSZip Missing");
                    const zip = await JSZip.loadAsync(f);
                    const container = await zip.file("META-INF/container.xml")?.async("string");
                    let rootPath = "";
                    if(container) {
                        const doc = new DOMParser().parseFromString(container, "text/xml");
                        rootPath = doc.querySelector("rootfile")?.getAttribute("full-path");
                    }
                    if(!rootPath) {
                        for (let filename in zip.files) { if (filename.endsWith(".xml") && !filename.includes("META-INF")) { rootPath = filename; break; } }
                    }
                    if(rootPath && zip.file(rootPath)) { xmlContent = await zip.file(rootPath).async("string"); } else { throw new Error("XML not found in MXL"); }
                } else {
                    xmlContent = await new Promise(r => { const fr = new FileReader(); fr.onload=e=>r(e.target.result); fr.readAsText(f); });
                }
                
                lastLoadedXML = xmlContent;
                const parser = new DOMParser(); const doc = parser.parseFromString(xmlContent, "text/xml");
                let bpm = 120;
                const perMinTag = doc.querySelector("per-minute");
                if (perMinTag) bpm = parseFloat(perMinTag.textContent);
                else { const soundTag = doc.querySelector("sound[tempo]"); if (soundTag) bpm = parseFloat(soundTag.getAttribute("tempo")); }
                if (isNaN(bpm) || bpm <= 0) bpm = 120;
                originalBPM = bpm; playbackSpeed = 1.0; setupBPMPresets(); updateTempoUI();
                renderSheet(xmlContent);
                ui.btnPlay.disabled = false; ui.btnStop.disabled = false; playbackManager.stop();
            } catch(err) { alert("Load Failed: " + err.message); }
            ui.fileInput.value = '';
        };

        ui.btnPlay.onclick = () => { if (audioCtx.state === 'suspended') audioCtx.resume(); if (playbackManager.isPlaying) { playbackManager.pause(); } else { playbackManager.play(lastLoadedXML); } };
        ui.btnStop.onclick = () => { playbackManager.stop(); };

        ui.btnView.onclick = () => {
            isSheetMode = !isSheetMode;
            if (isSheetMode) {
                ui.btnView.classList.add('sheet-active'); ui.btnView.textContent = "üéº"; ui.mainStage.classList.add('sheet-mode');
            } else {
                ui.btnView.classList.remove('sheet-active'); ui.btnView.textContent = "üëÅÔ∏è"; ui.mainStage.classList.remove('sheet-mode');
                if (!isRunning) ui.startBtn.style.display = 'block';
            }
        };

        // === v7.6 RECORDING STUDIO FIX ===
        let isRecording = false; let recordedNotes = []; let currentNoteEvent = null; let noteStartTime = 0;
        
        ui.btnRec.onclick = () => {
            isRecording = !isRecording;
            if (isRecording) {
                recordedNotes = []; currentNoteEvent = null;
                ui.btnRec.classList.add('recording'); ui.btnRec.textContent = "‚óè REC (0)"; // Reset Count
                ui.btnExport.style.display = 'none';
            } else {
                if(currentNoteEvent) recordedNotes.push({...currentNoteEvent, duration: Date.now()-noteStartTime});
                ui.btnRec.classList.remove('recording'); ui.btnRec.textContent = "‚óè REC";
                if(recordedNotes.length) ui.btnExport.style.display = 'flex';
            }
        };
        
        // REC Helper Function used by update() loop
        function processRecording(detectedNote, detectedOctave) {
            const now = Date.now();
            
            // If silence (arguments are null)
            if (!detectedNote) {
                if (currentNoteEvent) {
                    recordedNotes.push({...currentNoteEvent, duration: now - noteStartTime});
                    ui.btnRec.textContent = `‚óè REC (${recordedNotes.length})`;
                    currentNoteEvent = null;
                }
                return;
            }

            // If note holding
            if (currentNoteEvent && detectedNote === currentNoteEvent.note && detectedOctave === currentNoteEvent.octave) {
                return;
            }

            // If note changed
            if (currentNoteEvent) {
                recordedNotes.push({...currentNoteEvent, duration: now - noteStartTime});
                ui.btnRec.textContent = `‚óè REC (${recordedNotes.length})`;
            }
            
            currentNoteEvent = {note: detectedNote, octave: detectedOctave};
            noteStartTime = now;
        }

        ui.btnExport.onclick = () => {
            let x = `<?xml version="1.0"?><!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 4.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd"><score-partwise version="4.0"><part-list><score-part id="P1"><part-name>Rec</part-name></score-part></part-list><part id="P1"><measure number="1"><attributes><divisions>1000</divisions></attributes>`;
            recordedNotes.forEach(n=>{ let s=n.note[0], a=n.note.includes('#'); x+=`<note><pitch><step>${s}</step>${a?'<alter>1</alter>':''}<octave>${n.octave}</octave></pitch><duration>${n.duration}</duration><type>whole</type></note>`; });
            x+=`</measure></part></score-partwise>`;
            const blob = new Blob([x], { type: 'text/xml' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `rec_${Date.now()}.musicxml`; a.click();
        };

        function renderSheet(xml) {
            if (!opensheetmusicdisplay) return;
            if (!osmd) { osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer", { autoResize: true, backend: "svg", drawTitle: false, drawingParameters: "compacttight" }); }
            osmd.load(xml).then(function() { osmd.zoom = currentZoom; osmd.render(); if(osmd.cursor) osmd.cursor.show(); });
        }
        window.zoomOSMD = function(f) { if (!osmd) return; currentZoom *= f; osmd.zoom = currentZoom; osmd.render(); };

        function initTargetSelect() {
            ui.targetSelect.innerHTML = "";
            for (let i = 24; i <= 107; i++) { 
                const noteName = notes[i % 12]; const oct = Math.floor(i / 12) - 1;
                const opt = document.createElement('option'); opt.value = i; opt.text = `${noteName}${oct}`; ui.targetSelect.appendChild(opt);
            }
        }
        initTargetSelect();
        
        function applyUI() {
            ui.a4Slider.value = appSettings.a4; ui.a4Display.innerText = appSettings.a4 + " Hz";
            ui.gateSlider.value = appSettings.gate; ui.gateDisplay.innerText = (appSettings.gate * 1000).toFixed(1);
            ui.smoothSlider.value = appSettings.smoothing; ui.smoothDisplay.innerText = Math.round(appSettings.smoothing * 100) + "%";
            ui.targetToggle.checked = appSettings.targetMode; ui.targetSelect.disabled = !appSettings.targetMode;
            ui.targetSelect.value = appSettings.targetNoteIndex;
            if(appSettings.targetMode) ui.appBody.classList.add('target-mode-active'); else ui.appBody.classList.remove('target-mode-active');
        }
        applyUI();

        ui.a4Slider.addEventListener('input', function() { appSettings.a4 = parseInt(this.value); ui.a4Display.innerText = appSettings.a4 + " Hz"; saveSettings(); });
        ui.gateSlider.addEventListener('input', function() { appSettings.gate = parseFloat(this.value); ui.gateDisplay.innerText = (appSettings.gate * 1000).toFixed(1); saveSettings(); });
        ui.smoothSlider.addEventListener('input', function() { appSettings.smoothing = parseFloat(this.value); ui.smoothDisplay.innerText = Math.round(appSettings.smoothing * 100) + "%"; saveSettings(); });
        ui.targetToggle.addEventListener('change', function() { appSettings.targetMode = this.checked; ui.targetSelect.disabled = !this.checked; if (this.checked) ui.appBody.classList.add('target-mode-active'); else ui.appBody.classList.remove('target-mode-active'); saveSettings(); });
        ui.targetSelect.addEventListener('change', function() { appSettings.targetNoteIndex = parseInt(this.value); saveSettings(); });
        
        const settingsModal = document.getElementById('settingsModal');
        const tempoModal = document.getElementById('tempoModal');
        document.getElementById('openSettings').onclick = () => settingsModal.style.display = 'block';
        document.getElementById('closeSettings').onclick = () => settingsModal.style.display = 'none';
        ui.btnTempo.onclick = () => tempoModal.style.display = 'block';
        document.getElementById('closeTempo').onclick = () => tempoModal.style.display = 'none';

        ui.startBtn.onclick = async function() {
            this.style.display = 'none';
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
                analyser = audioCtx.createAnalyser(); analyser.smoothingTimeConstant = 0.8;
                gainNode = audioCtx.createGain(); gainNode.gain.value = 5.0; 
                micSource = audioCtx.createMediaStreamSource(mediaStream); micSource.connect(gainNode); gainNode.connect(analyser); 
                setMode('turbo'); isRunning = true; update();
            } catch (e) { alert("Mic Error: " + e.message); this.style.display = 'block'; }
        };

        function playMusicXML(xmlString) {
             const parser = new DOMParser(); const doc = parser.parseFromString(xmlString, "text/xml");
             if (doc.querySelector("parsererror")) { alert("XML Parsing Error"); ui.btnPlay.textContent = "‚ñ∂"; return; }

             let divisions = 480;
             const divTag = doc.querySelector("divisions");
             if (divTag) { const val = parseFloat(divTag.textContent); if (!isNaN(val) && val > 0) divisions = val; }

             let bpm = originalBPM; 
             const effectiveBPM = bpm * playbackSpeed;
             const isLegacy = (divisions === 1000 && !doc.querySelector("per-minute") && !doc.querySelector("sound"));

             playbackManager.isPlaying = true; ui.btnPlay.textContent = "‚è∏"; ui.btnPlay.classList.add('playing');
             if (isSheetMode && osmd) { osmd.cursor.reset(); osmd.cursor.show(); }

             const parts = doc.querySelectorAll("part");
             let maxGlobalTime = 0;
             const startTimeRef = audioCtx.currentTime + 0.1;

             parts.forEach((part, partIndex) => {
                 let currentTime = 0;
                 part.querySelectorAll("measure").forEach(measure => {
                     const children = Array.from(measure.childNodes).filter(n => n.nodeType === 1);
                     let measureCursor = 0;
                     children.forEach(node => {
                         if (node.tagName === "note") {
                             const isRest = node.querySelector("rest") !== null;
                             const isChord = node.querySelector("chord") !== null;
                             const durNode = node.querySelector("duration");
                             let durationSec = 0.05;
                             if(durNode) {
                                 let d = parseFloat(durNode.textContent);
                                 if(isLegacy) durationSec = (d/1000) / playbackSpeed; else durationSec = (d/divisions)*(60/effectiveBPM);
                             }
                             if(durationSec<0.05) durationSec=0.05;

                             let noteStart = currentTime + measureCursor;
                             if (isChord) noteStart = window.lastNoteStart || noteStart; 
                             else { window.lastNoteStart = noteStart; measureCursor += durationSec; }

                             if (!isChord && !isRest && partIndex === 0) {
                                 const cursorId = setTimeout(() => {
                                     if (playbackManager.isPlaying && osmd && osmd.cursor) {
                                         try { 
                                             osmd.cursor.next(); 
                                             if (isSheetMode) osmd.cursor.cursorElement.scrollIntoView({behavior: "smooth", block: "center"});
                                         } catch(e){}
                                     }
                                 }, (startTimeRef + noteStart - audioCtx.currentTime) * 1000);
                                 playbackManager.timeouts.push(cursorId);
                             }

                             if (!isRest) {
                                 const step = node.querySelector("step")?.textContent; const oct = node.querySelector("octave")?.textContent; const alt = node.querySelector("alter")?.textContent;
                                 if (step && oct) {
                                     let nn = step + (alt==="1"?"#":"");
                                     if(alt==="-1") { const map={"D":"C#","E":"D#","G":"F#","A":"G#","B":"A#"}; if(map[step]) nn=map[step]; }
                                     const f = appSettings.a4 * Math.pow(2, ((parseInt(oct)+1)*12 + ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(nn)-69)/12);
                                     const t1 = setTimeout(() => {
                                         if(!playbackManager.isPlaying) return;
                                         const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
                                         osc.frequency.value = f; g.gain.setValueAtTime(0, audioCtx.currentTime);
                                         g.gain.linearRampToValueAtTime(masterVolume*0.3, audioCtx.currentTime+0.02);
                                         g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+durationSec);
                                         osc.connect(g); g.connect(audioCtx.destination); osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime+durationSec);
                                         const k = document.querySelector(`.key[data-note="${nn}"]`); if(k) k.classList.add('pressed');
                                     }, (startTimeRef + noteStart - audioCtx.currentTime) * 1000);
                                     const t2 = setTimeout(() => {
                                         if(!playbackManager.isPlaying) return;
                                         const k = document.querySelector(`.key[data-note="${nn}"]`); if(k) k.classList.remove('pressed');
                                     }, (startTimeRef + noteStart + durationSec - audioCtx.currentTime) * 1000);
                                     playbackManager.timeouts.push(t1, t2);
                                 }
                             }
                             maxGlobalTime = Math.max(maxGlobalTime, noteStart + durationSec);
                         } 
                         else if (node.tagName === "backup") {
                             const d = parseFloat(node.querySelector("duration")?.textContent||0);
                             measureCursor -= (d/divisions)*(60/effectiveBPM);
                         }
                         else if (node.tagName === "forward") {
                             const d = parseFloat(node.querySelector("duration")?.textContent||0);
                             measureCursor += (d/divisions)*(60/effectiveBPM);
                         }
                     });
                     currentTime += Math.max(measureCursor, 0); 
                 });
             });
             const finishId = setTimeout(() => { playbackManager.stop(); }, (startTimeRef + maxGlobalTime - audioCtx.currentTime) * 1000 + 500);
             playbackManager.timeouts.push(finishId);
        }

        function update() {
            if(!isRunning) return; analyser.getFloatTimeDomainData(dataArray);
            let sum=0; for(let i=0;i<dataArray.length;i+=4) sum+=dataArray[i]*dataArray[i];
            const rms = Math.sqrt(sum/(dataArray.length/4));
            let cents = null; let hasSignal = false;
            
            // Capture these for Recording Logic
            let recNote = null;
            let recOct = null;

            if(rms > appSettings.gate) {
                const p = detectPitch(dataArray, audioCtx.sampleRate);
                if(p!==-1 && p>25 && p<4200) {
                    hasSignal = true;
                    const noteFloat = 12 * (Math.log(p/appSettings.a4)/Math.log(2));
                    let rNote = Math.round(noteFloat)+69;
                    if(appSettings.targetMode) rNote = appSettings.targetNoteIndex;
                    
                    const dNote = notes[rNote%12]; const dOct = Math.floor(rNote/12)-1;
                    const fNote = appSettings.a4 * Math.pow(2, (rNote-69)/12);
                    const rCents = Math.floor(1200 * Math.log(p/fNote)/Math.log(2));
                    
                    // Assign for Recording
                    recNote = dNote;
                    recOct = dOct;

                    smoothedCents = (smoothedCents*appSettings.smoothing) + (rCents*(1-appSettings.smoothing));
                    cents = smoothedCents; lastValidCents = cents; framesSinceLastSignal = 0; currentCents = cents; isSignalActive = true;
                    
                    ui.hz.textContent = p.toFixed(1); ui.cents.textContent = (cents>0?"+":"")+cents.toFixed(0);
                    if(lastNoteName !== dNote+dOct) {
                        ui.note.textContent = dNote; ui.oct.textContent = dOct; lastNoteName = dNote+dOct;
                        ui.keys.forEach(k=>k.classList.remove('active'));
                        const k=document.querySelector(`.key[data-note="${dNote}"]`); if(k) k.classList.add('active');
                    }
                }
            }
            if(!hasSignal) {
                framesSinceLastSignal++;
                if(framesSinceLastSignal<SIGNAL_HOLD_FRAMES) { cents = lastValidCents; isSignalActive = true; }
                else { isSignalActive = false; cents = null; }
            }
            
            // v7.6 FIX: Process actual detected note for recording
            if(isRecording) processRecording(recNote, recOct);
            
            pitchHistory.pop(); pitchHistory.unshift(cents);
            drawVisualizer(); requestAnimationFrame(update);
        }

        function drawVisualizer() {
            if (isSheetMode) return;
            const w = canvas.parentElement.clientWidth; const h = canvas.parentElement.clientHeight; canvas.width = w; canvas.height = h;
            const isLocked = isSignalActive && currentCents !== null && Math.abs(currentCents) <= 5;
            if (isLocked) {
                ctx.fillStyle = "#66cc66"; ctx.fillRect(0, 0, w, h); ctx.strokeStyle = "rgba(255,255,255,0.8)"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h); ctx.stroke();
            } else {
                const centerW = w * 0.15; ctx.fillStyle = "#ff5252"; ctx.fillRect(0, 0, w/2 - centerW/2, h); ctx.fillStyle = "#66cc66"; ctx.fillRect(w/2 - centerW/2, 0, centerW, h); ctx.fillStyle = "#ff5252"; ctx.fillRect(w/2 + centerW/2, 0, w, h); ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h); ctx.stroke();
            }
            ctx.strokeStyle = "#ffffff"; ctx.lineWidth = 4; ctx.lineCap = "round"; ctx.lineJoin = "round"; ctx.beginPath();
            const rowH = h / historySize; let lastX = null;
            for (let i = 0; i < historySize; i++) {
                if (pitchHistory[i] !== null) {
                    const val = Math.max(-50, Math.min(50, pitchHistory[i])); const x = (val + 50) / 100 * w; const y = i * rowH;
                    if (lastX === null) ctx.moveTo(x, y); else if (Math.abs(x - lastX) < w * 0.8) ctx.lineTo(x, y); else ctx.moveTo(x, y);
                    lastX = x;
                } else lastX = null;
            }
            ctx.stroke();
        }

        function detectPitch(buffer, sampleRate) {
            const threshold = 0.15; const halfSize = Math.floor(buffer.length / 2); const yinBuffer = new Float32Array(halfSize);
            for (let t = 0; t < halfSize; t++) { let sum = 0; for (let i = 0; i < halfSize; i += downsampleStep) { const d = buffer[i] - buffer[i + t]; sum += d * d; } yinBuffer[t] = sum; }
            yinBuffer[0] = 1; let runningSum = 0; for (let t = 1; t < halfSize; t++) { runningSum += yinBuffer[t]; yinBuffer[t] *= t / runningSum; }
            let tau = -1; for (let t = 2; t < halfSize; t++) { if (yinBuffer[t] < threshold) { while (t + 1 < halfSize && yinBuffer[t + 1] < yinBuffer[t]) t++; tau = t; break; } }
            if (tau === -1) return -1; const x0 = yinBuffer[tau - 1], x2 = yinBuffer[tau + 1], x1 = yinBuffer[tau];
            return sampleRate / (tau + (x2 - x0) / (2 * (2 * x1 - x2 - x0)));
        }
        
        window.setMode = (mode) => { if (mode === 'turbo') { currentFFTSize = 2048; downsampleStep = 2; document.getElementById('modeTurbo').className = 'mode-card selected'; document.getElementById('modeBass').className = 'mode-card'; } else { currentFFTSize = 4096; downsampleStep = 2; document.getElementById('modeTurbo').className = 'mode-card'; document.getElementById('modeBass').className = 'mode-card selected'; } if (analyser) { analyser.fftSize = currentFFTSize; dataArray = new Float32Array(analyser.fftSize); } };
        window.applyPreset = (inst) => { let startNote = 69; if (inst === 'guitar') startNote = 40; if (inst === 'bass') startNote = 28; if (inst === 'ukulele') startNote = 69; if (inst === 'violin') startNote = 69; appSettings.targetNoteIndex = startNote; appSettings.targetMode = true; ui.targetToggle.checked = true; applyUI(); saveSettings(); };
        
        ui.keys.forEach(key => {
            const note = key.getAttribute('data-note');
            const press = (e) => { e.preventDefault(); key.classList.add('pressed'); startTone(note); };
            const release = (e) => { e.preventDefault(); key.classList.remove('pressed'); stopTone(); };
            key.addEventListener('mousedown', press); key.addEventListener('mouseup', release); key.addEventListener('mouseleave', release); key.addEventListener('touchstart', press); key.addEventListener('touchend', release);
        });
        
        ui.volSlider.addEventListener('input', function() { masterVolume = parseFloat(this.value); ui.volDisplay.textContent = Math.round(masterVolume * 100) + "%"; if (toneGain) toneGain.gain.setTargetAtTime(masterVolume, audioCtx.currentTime, 0.1); });
        
        function startTone(noteName) { if (audioCtx.state === 'suspended') audioCtx.resume(); const semitones = notes.indexOf(noteName); const noteNum = (keyboardOctave + 1) * 12 + semitones; const freq = appSettings.a4 * Math.pow(2, (noteNum - 69) / 12); if (toneOsc) stopTone(); toneOsc = audioCtx.createOscillator(); toneGain = audioCtx.createGain(); toneOsc.type = 'sine'; toneOsc.frequency.setValueAtTime(freq, audioCtx.currentTime); toneGain.gain.setValueAtTime(0, audioCtx.currentTime); toneGain.gain.linearRampToValueAtTime(masterVolume, audioCtx.currentTime + 0.05); toneGain.connect(audioCtx.destination); if (analyser) toneGain.connect(analyser); toneOsc.connect(toneGain); toneOsc.start(); }
        function stopTone() { if (toneOsc && toneGain) { const stopTime = audioCtx.currentTime + 0.1; toneGain.gain.cancelScheduledValues(audioCtx.currentTime); toneGain.gain.setValueAtTime(toneGain.gain.value, audioCtx.currentTime); toneGain.gain.linearRampToValueAtTime(0, stopTime); toneOsc.stop(stopTime); const oldOsc = toneOsc; const oldGain = toneGain; setTimeout(() => { oldOsc.disconnect(); oldGain.disconnect(); }, 200); toneOsc = null; toneGain = null; } }
        function stopMic() { 
            if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); mediaStream = null; } 
            isRunning = false;
            if (!isSheetMode) {
                ui.startBtn.style.display = 'block'; 
                ui.startBtn.innerText = "‚ö° ÈáçÊñ∞ÂïüÂãï (Resume)"; 
            }
        }
        document.addEventListener('visibilitychange', () => { if (document.hidden) { stopMic(); playbackManager.pause(); } });

    </script>
</body>
</html>
