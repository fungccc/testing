<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AURA Studio v10.1 - Omni Station (Mobile Fixed)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.8/build/opensheetmusicdisplay.min.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-panel: rgba(18, 18, 20, 0.98); /* Âä†Ê∑±ËÉåÊôØÈò≤ÈÄèË¶ñÂπ≤Êìæ */
            --glass-border: rgba(255, 255, 255, 0.15);
            
            --neon-cyan: #00f2ff;
            --neon-purple: #bd00ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            --neon-orange: #ff9d00;
            
            --text-main: #ffffff;
            --text-mute: #999;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: radial-gradient(circle at 50% 30%, #1a1a1a 0%, #000 80%);
            color: var(--text-main); font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; display: flex; flex-direction: column; 
            height: 100vh; height: 100dvh; /* Mobile Fix */
            overflow: hidden; user-select: none;
        }

        /* --- TOP BAR --- */
        .top-bar {
            height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
            z-index: 200; position: absolute; top:0; width:100%; pointer-events: none; /* Let clicks pass */
        }
        /* Fix: Á¢∫‰øùÊåâÈàïÂçÄÂüüÂèØÈªûÊìä */
        .top-left, .top-right { pointer-events: auto; display: flex; gap: 8px; align-items: center; }
        
        .brand-pill {
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 6px 14px; display: flex; align-items: center; gap: 8px;
        }
        .brand-logo { font-weight: 800; font-size: 0.9rem; letter-spacing: 1px; background: linear-gradient(90deg, #fff, var(--neon-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .indicator-dot { width:8px; height:8px; border-radius:50%; background:#444; transition:0.3s; }
        .indicator-dot.active { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }

        .icon-btn {
            width: 42px; height: 42px; border-radius: 50%; background: rgba(30,30,30,0.8); border: 1px solid var(--glass-border);
            color: #eee; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s;
            z-index: 201; /* Fix: Ensure clickable */
        }
        .icon-btn:active { transform: scale(0.9); background: #333; }
        .icon-btn.primary { border-color: var(--neon-cyan); color: var(--neon-cyan); }

        /* --- STAGE --- */
        .viewport-stage { flex: 1; position: relative; overflow: hidden; width: 100%; margin-top: 60px; } /* Adjust for top-bar */
        #tunerCanvas { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #osmdContainer { 
            position: absolute; top: 10px; bottom: 20px; left: 10px; right: 10px;
            background: #fff; border-radius: 4px; box-shadow: 0 0 30px rgba(0,0,0,0.8);
            opacity: 0; pointer-events: none; transition: opacity 0.3s; overflow: auto;
            /* Fix: Better scroll on mobile */
            -webkit-overflow-scrolling: touch;
        }
        .sheet-active #tunerCanvas { opacity: 0; pointer-events: none; }
        .sheet-active #osmdContainer { opacity: 1; pointer-events: auto; }

        /* --- HUD --- */
        .hud-capsule {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; pointer-events: none; z-index: 50; transition: 0.3s;
        }
        .sheet-active .hud-capsule { top: 10px; transform: translateX(-50%) scale(0.6); opacity: 0.8; }

        .note-ring {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.3); transition: border-color 0.2s;
        }
        .note-ring.perfect { border-color: var(--neon-green); box-shadow: 0 0 30px rgba(0, 255, 157, 0.5); }
        .note-ring.good { border-color: #ffd700; }
        
        .hud-note { font-size: 4rem; font-weight: 300; line-height: 1; color: #fff; }
        .hud-octave { font-size: 1.2rem; position: absolute; top: 25px; right: 20px; color: var(--text-mute); }
        .hud-data { display: flex; gap: 8px; margin-top: 8px; }
        .data-tag { background: rgba(0,0,0,0.6); padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-family: monospace; color: #ccc; border: 1px solid var(--glass-border); }
        
        /* --- COMMAND DECK (Mobile Fixed) --- */
        .command-deck {
            background: var(--bg-panel); border-top: 1px solid var(--glass-border);
            padding: 10px; z-index: 90; height: 85px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        
        /* Fix: Center deck is scrollable on mobile */
        .deck-center { 
            display: flex; gap: 10px; align-items: center; flex: 1; 
            overflow-x: auto; white-space: nowrap; 
            scrollbar-width: none; /* Hide scrollbar */
            padding-right: 10px;
        }
        .deck-center::-webkit-scrollbar { display: none; }

        .deck-left { display: flex; flex-direction: column; gap: 2px; min-width: 60px; } /* BPM Info */
        .deck-right { display: flex; gap: 8px; }

        .info-group { display: flex; flex-direction: column; cursor: pointer; }
        .info-label { font-size: 0.5rem; color: #666; letter-spacing: 1px; }
        .info-val { font-family: "Courier New", monospace; font-size: 1rem; color: var(--neon-cyan); font-weight: bold; }

        /* Mobile Hide: Hide Deck Left on very small screens */
        @media (max-width: 360px) { .deck-left { display: none; } }

        .transport-btn {
            width: 48px; height: 48px; border-radius: 14px; background: #222; border: 1px solid #333; color: #fff;
            font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .transport-btn:active { background: #444; }
        .transport-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .transport-btn.playing { background: rgba(255,0,85,0.2); color: var(--neon-pink); border-color: var(--neon-pink); }
        .transport-btn.recording { background: var(--neon-pink); color: #fff; animation: pulse 1.5s infinite; }
        
        .loop-controls, .track-controls { 
            display: flex; gap: 4px; background: #111; padding: 4px; border-radius: 12px; border: 1px solid #333; flex-shrink: 0; 
        }
        .loop-btn, .track-btn { 
            width: 34px; height: 34px; border-radius: 8px; border: none; background: transparent; color: #555; 
            font-size: 0.8rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .loop-btn.active { background: var(--neon-cyan); color: #000; }
        .track-btn.active#btnToggleMetro { color: var(--neon-cyan); background: rgba(0,242,255,0.1); }
        .track-btn.active#btnToggleMelody { color: var(--neon-purple); background: rgba(189,0,255,0.1); }

        /* --- KEYBOARD DRAWER --- */
        .keyboard-drawer {
            background: #080808; border-top: 1px solid #222; overflow: hidden; height: 0; transition: height 0.3s;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .keyboard-drawer.open { height: 130px; }
        
        .octave-scroller { display: flex; gap: 8px; padding: 6px; justify-content: center; background: #111; overflow-x: auto; }
        .pill { font-size: 0.7rem; padding: 4px 10px; color: #666; border: 1px solid #333; border-radius: 12px; background: transparent; white-space: nowrap; }
        .pill.active { background: rgba(0,242,255,0.15); color: var(--neon-cyan); border-color: var(--neon-cyan); }

        .keys-container { flex: 1; display: flex; justify-content: center; gap: 8px; padding-bottom: 5px; }
        .key-group { display: flex; flex-direction: column; align-items: center; }
        .sharps { display: flex; gap: 8px; margin-bottom: -18px; z-index: 10; pointer-events: none; }
        .sharps .key { pointer-events: auto; }
        .naturals { display: flex; gap: 2px; }
        
        .key { cursor: pointer; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; font-weight: bold; border-radius: 0 0 4px 4px; }
        .key.natural { width: 36px; height: 65px; background: #eee; color: #333; border-bottom: 4px solid #ccc; font-size: 0.7rem; }
        .key.sharp { width: 26px; height: 40px; background: #222; color: #fff; border-bottom: 4px solid #000; font-size: 0.6rem; }
        .key.active { background: var(--neon-cyan) !important; color: #000 !important; } 
        .key.drone { background: var(--neon-orange) !important; color: #000 !important; animation: pulse 2s infinite; }

        /* --- MODALS & OVERLAYS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 300; }
        /* Fix: Max height for mobile landscape */
        .modal-content { max-width: 450px; margin: 20px auto; background: #151515; border: 1px solid var(--glass-border); padding: 20px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
        .setting-row { margin-bottom: 15px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 8px; color: #aaa; font-size: 0.85rem; }
        input[type=range] { width: 100%; height: 4px; background: #333; -webkit-appearance: none; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #fff; border-radius: 50%; }
        
        /* Fix: Start Overlay z-index and click-through */
        .start-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); 
            z-index: 250; /* Above stage, below modal */
            display:flex; justify-content:center; align-items:center; 
        }
        #startBtn { padding: 16px 40px; border-radius: 40px; border: none; background: var(--neon-cyan); font-size: 1.1rem; font-weight: 800; cursor: pointer; box-shadow: 0 0 30px var(--neon-cyan); letter-spacing: 1px; }

        .hidden-file { display: none; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,85,0.7); } 100% { box-shadow: 0 0 0 10px rgba(255,0,85,0); } }
    </style>
</head>
<body id="appBody">

    <nav class="top-bar">
        <div class="top-left">
            <button class="icon-btn" id="openSettings" title="Settings">‚öôÔ∏è</button>
            <div class="brand-pill">
                <span class="brand-logo">AURA v10.1</span>
                <div class="indicator-dot" id="midiStatus"></div>
            </div>
        </div>
        <div class="top-right">
            <div id="backingTrackStatus" class="brand-pill" style="display:none; margin-right:5px; border-color:var(--neon-purple);">
                <span style="color:var(--neon-purple); font-size:0.7rem;">‚ô™ AUDIO</span>
                <span onclick="clearBackingTrack()" style="cursor:pointer; margin-left:8px;">‚úï</span>
            </div>
            <button class="icon-btn" id="btnLoad" title="Load MusicXML / Audio" style="background:var(--neon-cyan); color:#000; box-shadow:0 0 15px rgba(0,242,255,0.3);">üìÇ</button>
            <input type="file" id="fileInput" class="hidden-file" accept=".xml,.mxl,.musicxml,.wav,.mp3">
            
            <button class="icon-btn primary" id="btnExportXML" style="display:none;">XML</button>
            <button class="icon-btn primary" id="btnExportWAV" style="display:none;">WAV</button>
        </div>
    </nav>

    <div class="viewport-stage" id="mainStage">
        <canvas id="tunerCanvas"></canvas>
        <div id="osmdContainer"></div>
        
        <div class="hud-capsule">
            <div class="note-ring" id="noteRing">
                <span id="note" class="hud-note">-</span>
                <span id="octave" class="hud-octave"></span>
            </div>
            <div class="hud-data">
                <div class="data-tag"><span id="hz">0.0</span> Hz</div>
                <div class="data-tag"><span id="cents">0</span> ¬¢</div>
            </div>
        </div>

        <div class="start-overlay" id="startOverlay">
            <button id="startBtn">INITIALIZE SYSTEM</button>
        </div>
        <div id="countInOverlay" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:8rem; color:var(--neon-cyan); opacity:0; pointer-events:none; z-index:260;"></div>
        
        <div style="position:absolute; bottom:20px; right:20px; display:flex; flex-direction:column; gap:8px; z-index:100;">
            <button class="icon-btn" onclick="zoomOSMD(1.1)">+</button>
            <button class="icon-btn" onclick="zoomOSMD(0.9)">-</button>
        </div>
    </div>

    <div class="command-deck">
        <div class="deck-left">
            <div class="info-group" id="btnTempo">
                <span class="info-label">BPM</span>
                <span class="info-val" id="bpmDisplay">120</span>
            </div>
        </div>

        <div class="deck-center">
            <div class="loop-controls">
                <button class="loop-btn" id="btnLoopA" title="Set A">A</button>
                <button class="loop-btn" id="btnLoopB" title="Set B">B</button>
                <button class="loop-btn" id="btnLoopToggle" title="Toggle Loop">‚Üª</button>
            </div>
            <div class="track-controls">
                <button class="track-btn active" id="btnToggleMetro">ü•Å</button>
                <button class="track-btn active" id="btnToggleMelody">üéπ</button>
            </div>

            <button class="transport-btn" id="btnStop" disabled>‚ñ†</button>
            <button class="transport-btn" id="btnPlay" disabled>‚ñ∂</button>
            <button class="transport-btn" id="btnRec" style="color:var(--neon-pink);">‚óè</button>
        </div>

        <div class="deck-right">
            <button class="icon-btn" id="btnView">üëÅÔ∏è</button>
            <button class="icon-btn" onclick="toggleKeyboard()">üéπ</button>
        </div>
    </div>

    <div class="keyboard-drawer" id="keyboardDrawer">
        <div class="octave-scroller" id="octaveScroller">
            <button class="pill" data-oct="2">C2</button>
            <button class="pill" data-oct="3">C3</button>
            <button class="pill active" data-oct="4">C4</button>
            <button class="pill" data-oct="5">C5</button>
            <button class="pill" data-oct="6">C6</button>
            <span style="color:#444; font-size:0.6rem; align-self:center; margin-left:10px;">Lock Drone</span>
        </div>
        <div class="keys-container">
            <div class="key-group">
                <div class="sharps"><div class="key sharp" data-note="C#"></div><div class="key sharp" data-note="D#"></div></div>
                <div class="naturals"><div class="key natural" data-note="C">C</div><div class="key natural" data-note="D">D</div><div class="key natural" data-note="E">E</div></div>
            </div>
            <div class="key-group">
                <div class="sharps"><div class="key sharp" data-note="F#"></div><div class="key sharp" data-note="G#"></div><div class="key sharp" data-note="A#"></div></div>
                <div class="naturals"><div class="key natural" data-note="F">F</div><div class="key natural" data-note="G">G</div><div class="key natural" data-note="A">A</div><div class="key natural" data-note="B">B</div></div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3 style="color:#fff; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px; display:flex; justify-content:space-between;">
                SYSTEM CONFIG <span id="closeSettings" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </h3>
            <div class="setting-row">
                <div class="label-row"><span>üéº Transpose</span> <span id="transDisplay" style="color:var(--neon-cyan)">0</span></div>
                <div style="display:flex; gap:10px; justify-content:space-between;">
                    <button class="pill" onclick="setTranspose(-1)">-1</button>
                    <button class="pill" onclick="setTranspose(0)">Reset</button>
                    <button class="pill" onclick="setTranspose(1)">+1</button>
                </div>
            </div>
            <div class="setting-row">
                <div class="label-row"><span>üîä Reverb Space</span> <span id="reverbStatus" style="color:#888">Off</span></div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="pill" id="btnReverbToggle" onclick="toggleReverb()">Toggle</button>
                    <input type="range" id="reverbMix" min="0" max="1" step="0.1" value="0.4" disabled>
                </div>
            </div>
            <div class="setting-row">
                <div class="label-row"><span>Master Vol</span> <span id="volValueDisplay">150%</span></div>
                <input type="range" id="volSlider" min="0.1" max="2.0" step="0.1" value="1.5">
            </div>
             <div class="setting-row">
                <div class="label-row"><span>A4 Ref</span> <span id="a4Display">440 Hz</span></div>
                <input type="range" id="a4Slider" min="430" max="450" step="1" value="440">
            </div>
        </div>
    </div>

    <div id="tempoModal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--neon-cyan); margin-bottom:20px;">RHYTHM <span id="closeTempo" style="float:right; cursor:pointer;">&times;</span></h3>
            <div class="setting-row">
                <div class="label-row"><span>Metronome</span> <span id="sigDisplay">4/4</span></div>
                <input type="checkbox" id="metroToggle"> Enable Click
            </div>
            <div class="setting-row">
                <div class="label-row"><span>Rate (0.1x - 10.0x)</span> <span id="origBpmDisplay">120</span></div>
                <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;">
                    <button class="pill" onclick="setSpeed(0.5)">0.5x</button>
                    <button class="pill" onclick="setSpeed(1.0)">1.0x</button>
                    <button class="pill" onclick="setSpeed(2.0)">2.0x</button>
                    <button class="pill" onclick="setSpeed(5.0)">5.0x</button>
                </div>
                <input type="range" id="rateSlider" min="0.1" max="10.0" step="0.1" value="1.0">
            </div>
            <div class="setting-row">
                <div class="label-row"><span>BPM Override</span></div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="pill" onclick="adjustBPM(-1)">-</button>
                    <input type="range" id="bpmSlider" min="20" max="999" step="1" value="120">
                    <button class="pill" onclick="adjustBPM(1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
            let analyser, micSource, gainNode, dataArray, mediaStream;
            let masterGain, reverbNode, reverbGain;
            let toneOsc = null, toneGain = null;
            let droneOsc = null, droneGain = null;
            let isRunning = false;
            
            // Audio Graph
            masterGain = audioCtx.createGain(); masterGain.gain.value = 1.0;
            reverbNode = audioCtx.createConvolver();
            reverbGain = audioCtx.createGain(); reverbGain.gain.value = 0.0;
            
            // Generate Reverb Impulse
            const sampleRate = audioCtx.sampleRate;
            const length = sampleRate * 2.0;
            const impulse = audioCtx.createBuffer(2, length, sampleRate);
            for (let c = 0; c < 2; c++) {
                const ch = impulse.getChannelData(c);
                for (let i = 0; i < length; i++) ch[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2.0);
            }
            reverbNode.buffer = impulse;
            
            masterGain.connect(audioCtx.destination);
            masterGain.connect(reverbNode);
            reverbNode.connect(reverbGain);
            reverbGain.connect(audioCtx.destination);

            let osmd = null;
            let isSheetMode = false;
            let lastParsedDoc = null;
            let originalBPM = 120;
            let playbackSpeed = 1.0;
            let isMetroEnabled = false;
            let isMelodyEnabled = true;
            let isLoopActive = false;
            let loopA = null; let loopB = null;
            let transposeSemitones = 0;
            let currentBeatsPerMeasure = 4;
            
            let backingBuffer = null; let backingSource = null; let backingGain = null;

            const ui = {
                hz: document.getElementById('hz'), note: document.getElementById('note'), oct: document.getElementById('octave'), cents: document.getElementById('cents'),
                noteRing: document.getElementById('noteRing'),
                btnPlay: document.getElementById('btnPlay'), btnStop: document.getElementById('btnStop'),
                btnRec: document.getElementById('btnRec'), btnLoopA: document.getElementById('btnLoopA'), btnLoopB: document.getElementById('btnLoopB'),
                btnToggleMetro: document.getElementById('btnToggleMetro'), btnToggleMelody: document.getElementById('btnToggleMelody'),
                startBtn: document.getElementById('startBtn'), startOverlay: document.getElementById('startOverlay'),
                keys: document.querySelectorAll('.key')
            };

            // --- UI HANDLERS ---
            ui.startBtn.onclick = async () => {
                await audioCtx.resume();
                ui.startOverlay.style.display = 'none';
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false } });
                    analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
                    micSource = audioCtx.createMediaStreamSource(mediaStream);
                    micSource.connect(analyser);
                    dataArray = new Float32Array(analyser.fftSize);
                    isRunning = true; updatePitch();
                    // Fix: Enable Play if file loaded before init
                    if(lastParsedDoc || backingBuffer) { ui.btnPlay.disabled = false; ui.btnStop.disabled = false; }
                } catch(e) { console.error(e); isRunning=true; updatePitch(); } // allow play without mic
            };

            // Loop
            ui.btnLoopA.onclick = () => { loopA = playbackManager.currentScoreTime; ui.btnLoopA.classList.add('active'); };
            ui.btnLoopB.onclick = () => { loopB = playbackManager.currentScoreTime; ui.btnLoopB.classList.add('active'); };
            document.getElementById('btnLoopToggle').onclick = function() {
                if(loopA!==null && loopB!==null && loopB>loopA) { isLoopActive=!isLoopActive; this.classList.toggle('active', isLoopActive); }
            };

            // Tracks
            ui.btnToggleMetro.onclick = () => { isMetroEnabled = !isMetroEnabled; ui.btnToggleMetro.classList.toggle('active', isMetroEnabled); document.getElementById('metroToggle').checked = isMetroEnabled; };
            ui.btnToggleMelody.onclick = () => { isMelodyEnabled = !isMelodyEnabled; ui.btnToggleMelody.classList.toggle('active', isMelodyEnabled); };

            // Settings
            window.setTranspose = (d) => { transposeSemitones = d===0 ? 0 : transposeSemitones+d; document.getElementById('transDisplay').textContent = transposeSemitones>0?"+"+transposeSemitones:transposeSemitones; if(osmd){osmd.Sheet.Transpose=transposeSemitones; osmd.updateGraphic(); osmd.render();} };
            window.toggleReverb = () => { 
                const gain = reverbGain.gain.value > 0 ? 0 : parseFloat(document.getElementById('reverbMix').value);
                reverbGain.gain.setTargetAtTime(gain, audioCtx.currentTime, 0.1);
                document.getElementById('reverbStatus').textContent = gain>0 ? "On" : "Off";
                document.getElementById('reverbMix').disabled = (gain===0);
            };
            document.getElementById('reverbMix').oninput = (e) => { reverbGain.gain.value = e.target.value; };
            
            // View & Keyboard
            document.getElementById('btnView').onclick = function() {
                isSheetMode = !isSheetMode;
                document.getElementById('mainStage').classList.toggle('sheet-active', isSheetMode);
                this.textContent = isSheetMode ? "üéº" : "üëÅÔ∏è";
            };
            window.toggleKeyboard = () => document.getElementById('keyboardDrawer').classList.toggle('open');
            window.zoomOSMD = (f) => { if(osmd) { osmd.zoom *= f; osmd.render(); } };

            // Modal Toggles
            const toggleModal = (id, show) => document.getElementById(id).style.display = show ? 'block' : 'none';
            document.getElementById('openSettings').onclick = () => toggleModal('settingsModal', true);
            document.getElementById('closeSettings').onclick = () => toggleModal('settingsModal', false);
            document.getElementById('btnTempo').onclick = () => toggleModal('tempoModal', true);
            document.getElementById('closeTempo').onclick = () => toggleModal('tempoModal', false);

            // Rate
            window.setSpeed = (r) => { playbackSpeed = r; document.getElementById('rateSlider').value = r; document.getElementById('rateDisplay').textContent = r.toFixed(1)+"x"; };
            document.getElementById('rateSlider').oninput = (e) => setSpeed(parseFloat(e.target.value));

            // --- PLAYBACK MANAGER ---
            const playbackManager = {
                timeouts: [], isPlaying: false, isPaused: false, currentScoreTime: 0,
                clear: function() { this.timeouts.forEach(t=>clearTimeout(t)); this.timeouts=[]; },
                play: function(doc, offset=0) {
                    if(this.isPaused && offset===0) {
                        audioCtx.resume(); this.isPaused=false; this.isPlaying=true; ui.btnPlay.textContent="‚è∏"; ui.btnPlay.classList.add('playing');
                    } else {
                        this.clear(); this.isPlaying=true; this.isPaused=false; this.currentScoreTime=offset;
                        ui.btnPlay.textContent="‚è∏"; ui.btnPlay.classList.add('playing');
                        
                        // Backing Track
                        if(backingBuffer) {
                            if(backingSource) try{backingSource.stop()}catch(e){}
                            backingSource = audioCtx.createBufferSource(); backingSource.buffer = backingBuffer;
                            backingSource.playbackRate.value = playbackSpeed;
                            backingGain = audioCtx.createGain(); backingGain.gain.value = 1.2;
                            backingSource.connect(backingGain); backingGain.connect(masterGain);
                            backingSource.start(0, offset);
                        }
                        if(doc) playMusicXML(doc, offset);
                    }
                },
                stop: function() {
                    this.clear(); this.isPlaying=false; this.isPaused=false; this.currentScoreTime=0;
                    ui.btnPlay.textContent="‚ñ∂"; ui.btnPlay.classList.remove('playing');
                    if(backingSource) try{backingSource.stop()}catch(e){}
                    if(osmd && osmd.cursor) osmd.cursor.reset();
                    document.querySelectorAll('.key.pressed').forEach(k=>k.classList.remove('pressed'));
                }
            };
            
            ui.btnStop.onclick = () => playbackManager.stop();
            ui.btnPlay.onclick = () => {
                if(!isRunning) { alert("Please click INITIALIZE SYSTEM first."); return; }
                playbackManager.isPlaying ? playbackManager.stop() : playbackManager.play(lastParsedDoc);
            };

            function playMusicXML(doc, startOffset) {
                let divisions = 480;
                const divTag = doc.querySelector("divisions");
                if (divTag) divisions = parseFloat(divTag.textContent);
                const secPerBeat = (60/originalBPM) / playbackSpeed;

                // Simple Sequencer
                const parts = doc.querySelectorAll("part");
                parts.forEach((part, pIdx) => {
                    let currentTime = 0;
                    part.querySelectorAll("measure").forEach((m, mIdx) => {
                        let mCursor = 0;
                        m.childNodes.forEach(node => {
                            if(node.tagName === "note") {
                                const dur = parseFloat(node.querySelector("duration")?.textContent||0);
                                const durSec = (dur/divisions)*(60/originalBPM);
                                const noteStart = currentTime + mCursor;
                                const isChord = node.querySelector("chord");
                                if(!isChord) mCursor += durSec;
                                
                                if(noteStart >= startOffset) {
                                    const delay = (noteStart - startOffset) / playbackSpeed;
                                    const realDur = durSec / playbackSpeed;
                                    
                                    // Cursor & Loop Check
                                    if(pIdx===0 && !isChord) {
                                        playbackManager.timeouts.push(setTimeout(() => {
                                            if(playbackManager.isPlaying) {
                                                playbackManager.currentScoreTime = noteStart;
                                                if(isLoopActive && noteStart >= loopB) { playbackManager.stop(); playbackManager.play(lastParsedDoc, loopA); return; }
                                                if(osmd.cursor) { osmd.cursor.next(); if(isSheetMode) osmd.cursor.cursorElement.scrollIntoView({behavior:"smooth", block:"nearest", inline:"center"}); }
                                            }
                                        }, delay*1000));
                                    }
                                    
                                    // Audio
                                    if(isMelodyEnabled && !node.querySelector("rest")) {
                                        const step = node.querySelector("step")?.textContent;
                                        const oct = node.querySelector("octave")?.textContent;
                                        const alt = node.querySelector("alter")?.textContent;
                                        if(step && oct) {
                                            let nn = step + (alt==="1"?"#":"");
                                            if(alt==="-1") nn = step==="B"?"A#":step==="E"?"D#":"G#";
                                            const baseMidi = (parseInt(oct)+1)*12 + notes.indexOf(nn);
                                            const freq = 440 * Math.pow(2, (baseMidi + transposeSemitones - 69)/12);
                                            
                                            playbackManager.timeouts.push(setTimeout(() => {
                                                if(playbackManager.isPlaying) playTone(freq, realDur, nn);
                                            }, delay*1000));
                                        }
                                    }
                                }
                            }
                        });
                        currentTime += mCursor;
                    });
                });
                
                // Metronome (Simplified Loop)
                let beatTime = Math.floor(startOffset/secPerBeat)*secPerBeat;
                while(beatTime < startOffset+300) {
                    if(beatTime >= startOffset) {
                        const d = (beatTime - startOffset)/playbackSpeed;
                        const idx = Math.round(beatTime/secPerBeat);
                        const strong = (idx % currentBeatsPerMeasure === 0);
                        playbackManager.timeouts.push(setTimeout(() => { if(playbackManager.isPlaying && isMetroEnabled) playClick(strong); }, d*1000));
                    }
                    beatTime += secPerBeat;
                }
            }

            function playTone(f, d, n) {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.type='triangle'; o.frequency.value=f; 
                g.gain.setValueAtTime(0, audioCtx.currentTime); 
                g.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime+0.01); 
                g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+d);
                o.connect(g); g.connect(masterGain); o.start(); o.stop(audioCtx.currentTime+d+0.1);
                const k=document.querySelector(`.key[data-note="${n}"]`); if(k){k.classList.add('pressed'); setTimeout(()=>k.classList.remove('pressed'), d*1000);}
            }
            function playClick(s) {
                const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
                o.frequency.value=s?1500:1000; g.gain.value=0.5;
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.05);
                o.connect(g); g.connect(masterGain); o.start(); o.stop(audioCtx.currentTime+0.05);
            }

            // LOAD FILE
            document.getElementById('btnLoad').onclick = () => document.getElementById('fileInput').click();
            document.getElementById('fileInput').onchange = (e) => {
                const f = e.target.files[0];
                if(f.name.match(/\.(wav|mp3)$/i)) {
                    const r = new FileReader();
                    r.onload = async (ev) => { backingBuffer = await audioCtx.decodeAudioData(ev.target.result); document.getElementById('backingTrackStatus').style.display = 'flex'; ui.btnPlay.disabled=false; ui.btnStop.disabled=false; };
                    r.readAsArrayBuffer(f);
                } else {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        const xml = ev.target.result;
                        lastParsedDoc = new DOMParser().parseFromString(xml, "text/xml");
                        // Fix: Auto-Switch to Sheet Mode
                        if(!osmd) osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer", {autoResize:true, backend:"svg", drawingParameters:"compacttight"});
                        osmd.load(xml).then(() => { 
                            osmd.render(); 
                            isSheetMode = true; document.getElementById('mainStage').classList.add('sheet-active'); 
                            document.getElementById('btnView').textContent = "üéº";
                            ui.btnPlay.disabled=false; ui.btnStop.disabled=false; 
                        });
                        // BPM
                        const b = lastParsedDoc.querySelector("per-minute"); if(b) originalBPM=parseFloat(b.textContent);
                        document.getElementById('origBpmDisplay').textContent = originalBPM;
                    };
                    r.readAsText(f);
                }
            };
            window.clearBackingTrack = () => { backingBuffer=null; document.getElementById('backingTrackStatus').style.display='none'; };

            // PITCH & DRONE
            const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
            function updatePitch() {
                if(!isRunning) return;
                analyser.getFloatTimeDomainData(dataArray);
                let rms=0; for(let i=0;i<dataArray.length;i++) rms+=dataArray[i]*dataArray[i];
                if(Math.sqrt(rms/dataArray.length)>0.01) {
                    // Simple Zero Crossing for speed
                    let zc=0; for(let i=1;i<dataArray.length;i++) if(dataArray[i]>0 && dataArray[i-1]<0) zc++;
                    // Basic pitch logic placeholder (Full autocorrelation in prod)
                    // Visualizer on Canvas
                }
                if(!isSheetMode) drawTuner();
                requestAnimationFrame(updatePitch);
            }
            function drawTuner() {
                const cvs = document.getElementById('tunerCanvas'); const cx = cvs.getContext('2d');
                cvs.width=cvs.clientWidth; cvs.height=cvs.clientHeight;
                cx.clearRect(0,0,cvs.width,cvs.height);
                cx.beginPath(); cx.strokeStyle='#00f2ff'; cx.lineWidth=2;
                for(let i=0;i<dataArray.length;i+=10) cx.lineTo(i/dataArray.length*cvs.width, cvs.height/2 + dataArray[i]*200);
                cx.stroke();
            }
            
            ui.keys.forEach(k => {
                k.onmousedown = (e) => {
                    const n = k.getAttribute('data-note');
                    if(droneOsc) {
                         droneGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.1); droneOsc.stop(audioCtx.currentTime+0.1); droneOsc=null;
                         document.querySelectorAll('.key.drone').forEach(kd=>kd.classList.remove('drone'));
                    } else {
                        droneOsc=audioCtx.createOscillator(); droneOsc.type='sawtooth';
                        const f = 440*Math.pow(2, ((3*12+notes.indexOf(n))-57)/12); // Drone at Oct 3
                        droneOsc.frequency.value=f; droneGain=audioCtx.createGain(); 
                        droneGain.gain.value=0.1; droneOsc.connect(droneGain); droneGain.connect(masterGain);
                        droneOsc.start();
                        k.classList.add('drone');
                    }
                }
            });
        });
    </script>
</body>
</html>
