<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AURA Studio - v9.0 Orbital Station</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.8.8/build/opensheetmusicdisplay.min.js"></script>

    <style>
        :root {
            /* --- ORBITAL THEME --- */
            --bg-deep: #000000;
            --bg-panel: rgba(20, 20, 23, 0.95);
            --glass-surface: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-blur: blur(24px);
            
            --text-main: #ffffff;
            --text-mute: #666666;
            
            /* NEON PALETTE */
            --neon-cyan: #00f2ff;
            --neon-purple: #bd00ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff9d;
            
            --panel-radius: 16px;
            --btn-radius: 8px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-deep);
            color: var(--text-main);
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        /* --- TOP SATELLITE BAR --- */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0; height: 60px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 100; pointer-events: none; /* Let clicks pass through empty space */
        }
        .top-left, .top-right { pointer-events: auto; display: flex; gap: 10px; align-items: center; }
        
        .brand-pill {
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 8px 16px; display: flex; align-items: center; gap: 8px;
        }
        .brand-logo { font-weight: 800; font-size: 0.9rem; letter-spacing: 2px; background: linear-gradient(90deg, #fff, var(--neon-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .midi-dot { font-size: 0.8rem; color: #333; transition: all 0.3s; }
        .midi-dot.connected { color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green); }

        .icon-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--glass-surface); border: 1px solid var(--glass-border);
            color: #ddd; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; transition: all 0.2s; backdrop-filter: blur(4px);
        }
        .icon-btn:hover { background: rgba(255,255,255,0.15); border-color: #fff; transform: translateY(-2px); }
        .icon-btn:active { transform: scale(0.95); }
        .icon-btn.primary { color: var(--neon-cyan); border-color: rgba(0, 242, 255, 0.3); }
        .icon-btn.danger { color: var(--neon-pink); border-color: rgba(255, 0, 85, 0.3); }

        /* --- ORBITAL STAGE (Visualizer/Sheet) --- */
        .viewport-stage {
            flex: 1; position: relative; overflow: hidden; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 40%, #1a1a1a 0%, #000 70%);
        }
        #tunerCanvas { width: 100%; height: 100%; display: block; position: absolute; }
        #osmdContainer { 
            position: absolute; top: 60px; bottom: 80px; left: 0; right: 0; /* Padding for bars */
            margin: auto; width: 95%; height: auto;
            background: #fff; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            opacity: 0; pointer-events: none; transition: opacity 0.3s; overflow: auto;
        }
        .viewport-stage.sheet-active #tunerCanvas { opacity: 0; }
        .viewport-stage.sheet-active #osmdContainer { opacity: 1; pointer-events: auto; }

        /* --- HUD CAPSULE --- */
        .hud-capsule {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center;
            pointer-events: none; z-index: 50; transition: all 0.3s;
        }
        .viewport-stage.sheet-active .hud-capsule { top: 20px; transform: translateX(-50%) scale(0.7); opacity: 0.8; } /* Mini HUD in sheet mode */

        .note-ring {
            width: 140px; height: 140px; border-radius: 50%;
            border: 2px solid var(--glass-border);
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.3); position: relative;
        }
        .hud-note { font-size: 5rem; font-weight: 200; line-height: 1; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .hud-octave { font-size: 1.5rem; position: absolute; top: 30px; right: 20px; color: var(--text-mute); font-weight: 300; }
        .hud-data { display: flex; gap: 15px; margin-top: 10px; }
        .data-tag { background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-family: monospace; color: var(--text-mute); border: 1px solid var(--glass-border); }
        .data-tag span { color: var(--neon-cyan); font-weight: bold; }
        
        .target-active .note-ring { border-color: var(--neon-cyan); box-shadow: 0 0 40px rgba(0, 242, 255, 0.2); }
        .target-active .hud-note { color: var(--neon-cyan); text-shadow: 0 0 30px var(--neon-cyan); }

        /* --- START BUTTON --- */
        .start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.3); z-index: 80; backdrop-filter: blur(2px);
        }
        #startBtn {
            padding: 20px 50px; border-radius: 50px; border: none;
            background: var(--neon-cyan); color: #000; font-weight: 800; font-size: 1.2rem;
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.4); cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 2px;
        }
        #startBtn:hover { transform: scale(1.05); box-shadow: 0 0 60px rgba(0, 242, 255, 0.6); }

        /* --- COMMAND DECK (Bottom) --- */
        .command-deck {
            background: var(--bg-panel); border-top: 1px solid var(--glass-border);
            padding: 15px 20px; z-index: 90;
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }

        .deck-left, .deck-right { display: flex; gap: 10px; align-items: center; }
        .deck-center { display: flex; gap: 15px; align-items: center; justify-content: center; }
        .deck-right { justify-content: flex-end; }

        .transport-btn {
            width: 56px; height: 56px; border-radius: 20px;
            background: #222; border: 1px solid #333; color: #fff;
            font-size: 1.4rem; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .transport-btn:hover { background: #333; border-color: #555; }
        .transport-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        #btnPlay.playing { background: rgba(255,0,85,0.2); color: var(--neon-pink); border-color: var(--neon-pink); box-shadow: 0 0 15px rgba(255,0,85,0.2); }
        #btnRec.recording { background: var(--neon-pink); color: #fff; animation: pulse 1.5s infinite; border: none; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,85,0.7); } 70% { box-shadow: 0 0 0 10px rgba(255,0,85,0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,85,0); } }

        .info-group { display: flex; flex-direction: column; cursor: pointer; }
        .info-label { font-size: 0.6rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .info-val { font-family: "Courier New", monospace; font-size: 1.1rem; color: var(--neon-cyan); font-weight: bold; }

        /* --- KEYBOARD DRAWER --- */
        .keyboard-drawer {
            background: #0a0a0a; border-top: 1px solid #222;
            overflow: hidden; height: 140px; transition: height 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .keyboard-drawer.collapsed { height: 0; border-top: none; }

        /* Reuse existing keyboard styles but refined */
        .octave-scroller { display: flex; overflow-x: auto; gap: 8px; padding: 10px; justify-content: center; background: #111; scrollbar-width: none; }
        .pill { font-size: 0.7rem; padding: 4px 10px; color: #666; border: 1px solid #333; border-radius: 12px; cursor: pointer; white-space: nowrap; }
        .pill.active { background: rgba(0,242,255,0.2); color: var(--neon-cyan); border-color: var(--neon-cyan); }
        
        .keys-container { flex: 1; display: flex; justify-content: center; gap: 12px; padding-bottom: 10px; padding-top: 5px;}
        .key-group { display: flex; flex-direction: column; align-items: center; }
        .sharps { display: flex; gap: 10px; margin-bottom: -15px; z-index: 2; pointer-events: none; } /* Ptr events hack: keys handle clicks */
        .sharps .key { pointer-events: auto; }
        .naturals { display: flex; gap: 2px; }
        
        .key { 
            cursor: pointer; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; 
            font-size: 0.8rem; font-weight: bold; border-radius: 0 0 4px 4px; user-select: none;
        }
        .key.natural { width: 40px; height: 80px; background: #eee; color: #333; border-bottom: 4px solid #ccc; }
        .key.natural:active, .key.natural.pressed { background: var(--neon-purple); color: #fff; border-color: var(--neon-purple); transform: scale(0.95); }
        .key.natural.active { background: var(--neon-cyan); } /* Tuner detected */
        
        .key.sharp { width: 32px; height: 50px; background: #333; color: #888; border-bottom: 4px solid #111; z-index: 10; }
        .key.sharp:active, .key.sharp.pressed { background: var(--neon-purple); color: #fff; border-color: var(--neon-purple); }
        .key.sharp.active { background: var(--neon-cyan); color: #000; }
        .key.midi-active { background: var(--neon-green) !important; color: #000 !important; }

        /* --- MODALS (Reused) --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 200; overflow-y: auto; }
        .modal-content { max-width: 500px; margin: 50px auto; background: #151515; border: 1px solid var(--glass-border); padding: 30px; border-radius: 20px; box-shadow: 0 20px 60px #000; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .modal-title { margin: 0; font-weight: 300; letter-spacing: 1px; color: #fff; }
        .close-icon { font-size: 2rem; cursor: pointer; color: #555; line-height: 0.8; }
        .close-icon:hover { color: #fff; }
        
        /* Modal internal components reuse original structure but cleaned up */
        .setting-row { margin-bottom: 25px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 10px; color: #aaa; font-size: 0.9rem; }
        .control-row { display: flex; align-items: center; gap: 15px; }
        
        /* Sliders */
        input[type=range] { flex: 1; height: 6px; background: #333; border-radius: 3px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        
        /* Selects */
        select.dark-input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; outline: none; }
        
        /* Toggle */
        .toggle-wrapper { display: flex; align-items: center; cursor: pointer; gap: 10px; }
        .toggle-track { width: 40px; height: 22px; background: #333; border-radius: 20px; position: relative; transition: 0.3s; }
        .toggle-dot { width: 16px; height: 16px; background: #888; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s; }
        input:checked + .toggle-track { background: var(--neon-cyan); }
        input:checked + .toggle-track .toggle-dot { transform: translateX(18px); background: #000; }

        /* Utility Helpers */
        .hidden-file { display: none; }
        #countInOverlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 15rem; font-weight: 900; color: var(--neon-cyan); opacity: 0; pointer-events: none; z-index: 150; text-shadow: 0 0 50px var(--neon-cyan); }
        
        /* Zoom Float */
        .zoom-float { position: absolute; bottom: 20px; right: 20px; display: none; flex-direction: column; gap: 10px; z-index: 80; }
        .viewport-stage.sheet-active .zoom-float { display: flex; }
        .mini-btn { width: 36px; height: 36px; border-radius: 50%; background: #222; border: 1px solid #444; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>
<body id="appBody">

    <nav class="top-bar">
        <div class="top-left">
            <button class="icon-btn" id="openSettings" title="Settings">‚öôÔ∏è</button>
            <div class="brand-pill">
                <span class="brand-logo">AURA v9</span>
                <span id="midiStatus" class="midi-dot" title="MIDI Status">‚óè</span>
            </div>
        </div>
        <div class="top-right">
            <button class="icon-btn primary" id="btnExportXML" title="Save XML" style="display:none;">XML</button>
            <button class="icon-btn primary" id="btnExportWAV" title="Save WAV" style="display:none;">WAV</button>
            <button class="icon-btn" id="btnLoad" title="Load MusicXML">üìÇ</button>
            <input type="file" id="fileInput" class="hidden-file" accept="*">
        </div>
    </nav>

    <div class="viewport-stage" id="mainStage">
        <canvas id="tunerCanvas"></canvas>
        <div id="osmdContainer"></div>
        
        <div class="hud-capsule">
            <div class="note-ring">
                <span id="note" class="hud-note">-</span>
                <span id="octave" class="hud-octave"></span>
            </div>
            <div class="hud-data">
                <div class="data-tag"><span id="hz">0.0</span> Hz</div>
                <div class="data-tag"><span id="cents">0</span> ¬¢</div>
            </div>
        </div>

        <div class="start-overlay" id="startOverlay">
            <button id="startBtn">Initialize System</button>
        </div>
        <div id="countInOverlay">4</div>
        <div class="zoom-float" id="zoomControls">
            <button class="mini-btn" onclick="zoomOSMD(1.1)">+</button>
            <button class="mini-btn" onclick="zoomOSMD(0.9)">-</button>
        </div>
    </div>

    <div class="command-deck">
        <div class="deck-left">
            <div class="info-group" id="btnTempo" title="Open Rhythm Settings">
                <span class="info-label">TEMPO</span>
                <span class="info-val" id="bpmDisplay">120</span>
            </div>
            <div class="info-group" style="margin-left:15px">
                <span class="info-label">RATE</span>
                <span class="info-val" id="rateDisplay">1.0x</span>
            </div>
        </div>

        <div class="deck-center">
            <button class="transport-btn" id="btnStop" disabled title="Stop / Reset">‚ñ†</button>
            <button class="transport-btn" id="btnPlay" disabled title="Play / Pause">‚ñ∂</button>
            <button class="transport-btn danger" id="btnRec" title="Record">‚óè</button>
        </div>

        <div class="deck-right">
            <button class="icon-btn" id="btnView" title="Toggle Sheet View">üëÅÔ∏è</button>
            <button class="icon-btn" onclick="toggleKeyboard()" title="Toggle Keyboard" style="margin-left:8px;">üéπ</button>
        </div>
    </div>

    <div class="keyboard-drawer" id="keyboardDrawer">
        <div class="octave-scroller" id="octaveScroller">
            <div class="pill" data-oct="1">C1</div>
            <div class="pill" data-oct="2">C2</div>
            <div class="pill" data-oct="3">C3</div>
            <div class="pill active" data-oct="4">C4</div>
            <div class="pill" data-oct="5">C5</div>
            <div class="pill" data-oct="6">C6</div>
        </div>
        <div class="keys-container">
            <div class="key-group">
                <div class="sharps">
                    <div class="key sharp" data-note="C#"></div>
                    <div class="key sharp" data-note="D#"></div>
                </div>
                <div class="naturals">
                    <div class="key natural" data-note="C">C</div>
                    <div class="key natural" data-note="D">D</div>
                    <div class="key natural" data-note="E">E</div>
                </div>
            </div>
            <div class="key-group">
                <div class="sharps">
                    <div class="key sharp" data-note="F#"></div>
                    <div class="key sharp" data-note="G#"></div>
                    <div class="key sharp" data-note="A#"></div>
                </div>
                <div class="naturals">
                    <div class="key natural" data-note="F">F</div>
                    <div class="key natural" data-note="G">G</div>
                    <div class="key natural" data-note="A">A</div>
                    <div class="key natural" data-note="B">B</div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">SYSTEM CONFIG</h2>
                <span class="close-icon" id="closeSettings">&times;</span>
            </div>
            
            <div class="setting-row">
                <div class="label-row"><span>Audio Mode</span></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="pill active" id="modeTurbo" onclick="setMode('turbo')" style="text-align:center; padding:10px;">‚ö° Turbo (Low Latency)</button>
                    <button class="pill" id="modeBass" onclick="setMode('bass')" style="text-align:center; padding:10px;">üê¢ Bass (Precision)</button>
                </div>
            </div>

            <div class="setting-row">
                <div class="label-row"><span>Instrument Preset</span></div>
                <select id="instPresetSelect" class="dark-input">
                    <option value="chromatic">Chromatic (All)</option>
                    <option value="violin">Violin</option>
                    <option value="cello">Cello</option>
                    <option value="guitar">Guitar</option>
                    <option value="ukulele">Ukulele</option>
                </select>
            </div>

            <div class="setting-row">
                <div class="label-row"><span>Master Volume</span> <span id="volValueDisplay">150%</span></div>
                <div class="control-row"><input type="range" id="volSlider" min="0.1" max="2.0" step="0.1" value="1.5"></div>
            </div>

            <div class="setting-row">
                <div class="label-row"><span>A4 Ref</span> <span id="a4Display">440 Hz</span></div>
                <div class="control-row"><input type="range" id="a4Slider" min="430" max="450" step="1" value="440"></div>
            </div>

            <div class="setting-row">
                <div class="label-row"><span>Target Lock</span></div>
                <label class="toggle-wrapper">
                    <input type="checkbox" id="targetModeToggle">
                    <div class="toggle-track"><div class="toggle-dot"></div></div>
                    <span style="font-size:0.8rem; color:#888;">Enable</span>
                </label>
                <select id="targetNoteSelect" class="dark-input" style="margin-top:10px;" disabled></select>
            </div>

             <div class="setting-row">
                <div class="label-row"><span>Gate / Smoothing</span></div>
                <div class="control-row">
                    <span style="font-size:0.8rem">G:</span> <input type="range" id="gateSlider" min="0.001" max="0.05" step="0.001" value="0.003">
                    <span id="gateDisplay" style="width:30px; font-size:0.8rem">3.0</span>
                </div>
                <div class="control-row" style="margin-top:5px;">
                    <span style="font-size:0.8rem">S:</span> <input type="range" id="smoothSlider" min="0.1" max="0.9" step="0.1" value="0.3">
                    <span id="smoothDisplay" style="width:30px; font-size:0.8rem">30%</span>
                </div>
            </div>
        </div>
    </div>

    <div id="tempoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" style="color:var(--neon-cyan)">RHYTHM ENGINE</h2>
                <span class="close-icon" id="closeTempo">&times;</span>
            </div>

            <div class="setting-row" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:0.9rem; color:#fff;">Metronome Click</div>
                    <div style="font-size:0.7rem; color:#666;" id="sigDisplay">4/4</div>
                </div>
                <label class="toggle-wrapper">
                    <input type="checkbox" id="metroToggle">
                    <div class="toggle-track"><div class="toggle-dot"></div></div>
                </label>
            </div>

            <div class="setting-row" style="display:flex; justify-content:space-between; align-items:center;">
                <div><div style="font-size:0.9rem; color:#fff;">Count-In (Pre-roll)</div></div>
                <label class="toggle-wrapper">
                    <input type="checkbox" id="countInToggle">
                    <div class="toggle-track"><div class="toggle-dot"></div></div>
                </label>
            </div>

            <div class="setting-row" style="background:rgba(255,255,255,0.03); padding:15px; border-radius:10px;">
                <div class="label-row"><span>Rate Control</span> <span id="origBpmDisplay" style="color:#666;">Ref: 120</span></div>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="pill" onclick="setSpeed(0.5)">0.5x</button>
                    <button class="pill" onclick="setSpeed(1.0)">1.0x</button>
                    <button class="pill" onclick="setSpeed(1.5)">1.5x</button>
                </div>
                <input type="range" id="rateSlider" min="0.2" max="2.0" step="0.01" value="1.0">
            </div>

            <div class="setting-row">
                <div class="label-row"><span>Manual BPM Override</span></div>
                <div id="bpmPresets" style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;"></div>
                <div class="control-row">
                    <button class="mini-btn" onclick="adjustBPM(-1)">-</button>
                    <input type="range" id="bpmSlider" min="20" max="240" step="1" value="120">
                    <button class="mini-btn" onclick="adjustBPM(1)">+</button>
                </div>
            </div>
            
            <div class="setting-row">
                 <div class="label-row"><span>Click Sound</span> <span id="accentPitchDisplay">1600 Hz</span></div>
                 <input type="range" id="accentPitchSlider" min="800" max="3000" step="100" value="1600">
                 <div class="label-row" style="margin-top:10px;"><span>Accent Ratio</span> <span id="accentRatioDisplay">1.5x</span></div>
                 <input type="range" id="accentRatioSlider" min="1.0" max="3.0" step="0.1" value="1.5">
            </div>
        </div>
    </div>

    <script>
        // UI Logic for New Layout
        function toggleKeyboard() {
            const drawer = document.getElementById('keyboardDrawer');
            const btn = document.querySelector('button[title="Toggle Keyboard"]');
            if(drawer.classList.contains('collapsed')) {
                drawer.classList.remove('collapsed');
                btn.style.color = 'var(--neon-cyan)';
            } else {
                drawer.classList.add('collapsed');
                btn.style.color = '#fff';
            }
        }
        
        // --- ORIGINAL LOGIC BELOW (No Deletions) ---
        document.addEventListener('DOMContentLoaded', () => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
            let analyser, micSource, gainNode, dataArray, mediaStream;
            let toneOsc = null, toneGain = null;
            let isRunning = false;
            let currentFFTSize = 2048; 
            let downsampleStep = 2;
            
            let osmd = null;
            let currentZoom = 1.0;
            let isSheetMode = false;
            let lastLoadedXML = null;
            let lastParsedDoc = null;

            // TEMPO & METRONOME STATE
            let originalBPM = 120;
            let playbackSpeed = 1.0;
            let isMetroEnabled = false;
            let isCountInEnabled = false;
            let currentBeatsPerMeasure = 4;
            let currentBeatType = 4;
            let accentPitch = 1600;
            let accentRatio = 1.5;

            // RECORDER STATE
            let mediaRecorder = null;
            let audioChunks = [];
            let wavBlob = null;

            const defaultSettings = { 
                a4: 440, gate: 0.003, smoothing: 0.3, 
                targetMode: false, targetNoteIndex: 69, 
                metroOn: false, countInOn: false, accentPitch: 1600, accentRatio: 1.5,
                preset: 'chromatic'
            };
            let appSettings = { ...defaultSettings };
            const saved = localStorage.getItem('aura_v8_settings');
            if (saved) { try { appSettings = { ...defaultSettings, ...JSON.parse(saved) }; } catch(e){} }
            function saveSettings() { localStorage.setItem('aura_v8_settings', JSON.stringify(appSettings)); }

            let keyboardOctave = 4;
            let masterVolume = 1.5;
            const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            
            const tuningPresets = {
                'chromatic': [],
                'violin': [55, 62, 69, 76], // G3, D4, A4, E5
                'viola': [48, 55, 62, 69],  // C3, G3, D4, A4
                'cello': [36, 43, 50, 57],  // C2, G2, D3, A3
                'doublebass': [28, 33, 38, 43], // E1, A1, D2, G2
                'erhu': [62, 69],           // D4, A4
                'ukulele': [69, 64, 60, 67], // A4, E4, C4, G4 (High G)
                'guitar': [40, 45, 50, 55, 59, 64] // E2, A2, D3, G3, B3, E4
            };

            const ui = {
                hz: document.getElementById('hz'), note: document.getElementById('note'), oct: document.getElementById('octave'), cents: document.getElementById('cents'),
                keys: document.querySelectorAll('.key'), btnRec: document.getElementById('btnRec'), 
                btnExportXML: document.getElementById('btnExportXML'), btnExportWAV: document.getElementById('btnExportWAV'),
                btnLoad: document.getElementById('btnLoad'), btnView: document.getElementById('btnView'), btnStop: document.getElementById('btnStop'),
                btnPlay: document.getElementById('btnPlay'), btnTempo: document.getElementById('btnTempo'), fileInput: document.getElementById('fileInput'),
                startBtn: document.getElementById('startBtn'), tunerCanvas: document.getElementById('tunerCanvas'), osmdContainer: document.getElementById('osmdContainer'),
                countInOverlay: document.getElementById('countInOverlay'),
                zoomControls: document.getElementById('zoomControls'), mainStage: document.getElementById('mainStage'), octavePills: document.querySelectorAll('.pill[data-oct]'),
                volSlider: document.getElementById('volSlider'), volDisplay: document.getElementById('volValueDisplay'),
                a4Slider: document.getElementById('a4Slider'), a4Display: document.getElementById('a4Display'),
                gateSlider: document.getElementById('gateSlider'), gateDisplay: document.getElementById('gateDisplay'),
                smoothSlider: document.getElementById('smoothSlider'), smoothDisplay: document.getElementById('smoothDisplay'),
                targetToggle: document.getElementById('targetModeToggle'), targetSelect: document.getElementById('targetNoteSelect'),
                appBody: document.getElementById('appBody'), origBpmDisplay: document.getElementById('origBpmDisplay'),
                rateDisplay: document.getElementById('rateDisplay'), rateSlider: document.getElementById('rateSlider'),
                bpmDisplay: document.getElementById('bpmDisplay'), bpmSlider: document.getElementById('bpmSlider'), bpmPresets: document.getElementById('bpmPresets'),
                metroToggle: document.getElementById('metroToggle'), countInToggle: document.getElementById('countInToggle'),
                sigDisplay: document.getElementById('sigDisplay'),
                accentPitchSlider: document.getElementById('accentPitchSlider'), accentPitchDisplay: document.getElementById('accentPitchDisplay'),
                accentRatioSlider: document.getElementById('accentRatioSlider'), accentRatioDisplay: document.getElementById('accentRatioDisplay'),
                instPresetSelect: document.getElementById('instPresetSelect'), midiStatus: document.getElementById('midiStatus')
            };
            const canvas = document.getElementById('tunerCanvas');
            const ctx = canvas.getContext('2d', { alpha: false });

            const historySize = 300; 
            const pitchHistory = new Array(historySize).fill(null);
            let lastNoteName = ""; let currentCents = 0; let isSignalActive = false; let lastValidCents = 0; let framesSinceLastSignal = 0; const SIGNAL_HOLD_FRAMES = 12; let smoothedCents = 0;

            // === MIDI SUPPORT ===
            if (navigator.requestMIDIAccess) {
                navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
            }
            function onMIDISuccess(midiAccess) {
                const inputs = midiAccess.inputs.values();
                for (let input of inputs) { input.onmidimessage = onMIDIMessage; ui.midiStatus.classList.add('connected'); }
                midiAccess.onstatechange = (e) => {
                    if(e.port.type === 'input' && e.port.state === 'connected') ui.midiStatus.classList.add('connected');
                    else if(midiAccess.inputs.size === 0) ui.midiStatus.classList.remove('connected');
                };
            }
            function onMIDIFailure() { console.log("MIDI not supported or access denied."); }
            function onMIDIMessage(event) {
                const [cmd, note, velocity] = event.data;
                const noteNameIndex = note % 12;
                const octave = Math.floor(note / 12) - 1;
                const noteName = notes[noteNameIndex];
                
                if (cmd === 144 && velocity > 0) { // Note On
                    const key = document.querySelector(`.key[data-note="${noteName}"]`);
                    if(key) key.classList.add('midi-active');
                    startTone(noteName, octave); // Synthesize sound
                    if(isRecording) processRecording(noteName, octave); // Record MIDI input
                } else if (cmd === 128 || (cmd === 144 && velocity === 0)) { // Note Off
                    const key = document.querySelector(`.key[data-note="${noteName}"]`);
                    if(key) key.classList.remove('midi-active');
                    stopTone(); // Ideally this should support polyphony, but monophonic for now
                }
            }

            // === PLAYBACK MANAGER ===
            const playbackManager = {
                timeouts: [],
                isPlaying: false,
                isPaused: false,
                isCountingIn: false,
                scoreAnchor: 0, 
                audioAnchor: 0,
                
                clearTimers: function() {
                    this.timeouts.forEach(id => clearTimeout(id));
                    this.timeouts = [];
                },

                play: function(xmlContentOrDoc, startOffset = 0) {
                    if (this.isPaused && startOffset === 0) {
                        audioCtx.resume(); this.isPaused = false; this.isPlaying = true;
                        ui.btnPlay.textContent = "‚è∏"; ui.btnPlay.classList.remove('paused'); ui.btnPlay.classList.add('playing');
                    } else {
                        if (!xmlContentOrDoc) return;
                        this.clearTimers();
                        if (isCountInEnabled && startOffset === 0 && !this.isCountingIn) {
                            this.startCountIn(xmlContentOrDoc);
                            return;
                        }
                        this.isPlaying = true; this.isPaused = false; this.isCountingIn = false;
                        this.scoreAnchor = startOffset;
                        this.audioAnchor = audioCtx.currentTime;
                        ui.btnPlay.textContent = "‚è∏"; ui.btnPlay.classList.add('playing');
                        if (isSheetMode && osmd && osmd.cursor) {
                            if (startOffset === 0) osmd.cursor.reset();
                            osmd.cursor.show();
                        }
                        playMusicXML(xmlContentOrDoc, startOffset);
                    }
                },

                startCountIn: function(xmlDoc) {
                    this.isCountingIn = true;
                    ui.btnPlay.disabled = true;
                    ui.countInOverlay.style.opacity = "0.8";
                    let bpm = originalBPM;
                    let secPerBeat = (60 / bpm) / playbackSpeed;
                    if (currentBeatType === 8) secPerBeat *= 0.5;
                    for (let i = 0; i < currentBeatsPerMeasure; i++) {
                        const beatNum = currentBeatsPerMeasure - i;
                        const delay = i * secPerBeat;
                        const t = setTimeout(() => {
                            ui.countInOverlay.textContent = beatNum;
                            const oldMetro = isMetroEnabled;
                            isMetroEnabled = true; 
                            playClick(i === 0, false);
                            isMetroEnabled = oldMetro;
                        }, delay * 1000);
                        this.timeouts.push(t);
                    }
                    const finalT = setTimeout(() => {
                        ui.countInOverlay.style.opacity = "0";
                        ui.btnPlay.disabled = false;
                        this.isCountingIn = false;
                        this.play(xmlDoc, 0);
                    }, currentBeatsPerMeasure * secPerBeat * 1000);
                    this.timeouts.push(finalT);
                },
                
                pause: function() {
                    if (this.isPlaying) {
                        audioCtx.suspend(); this.isPlaying = false; this.isPaused = true;
                        ui.btnPlay.textContent = "‚ñ∂"; ui.btnPlay.classList.remove('playing'); ui.btnPlay.classList.add('paused');
                    }
                },
                
                stop: function() {
                    this.clearTimers(); this.isPlaying = false; this.isPaused = false; this.isCountingIn = false;
                    this.scoreAnchor = 0; this.audioAnchor = 0;
                    ui.countInOverlay.style.opacity = "0";
                    ui.btnPlay.disabled = false;
                    audioCtx.resume();
                    ui.btnPlay.textContent = "‚ñ∂"; ui.btnPlay.classList.remove('playing', 'paused');
                    document.querySelectorAll('.key.pressed').forEach(k => k.classList.remove('pressed'));
                    if (osmd && osmd.cursor) { osmd.cursor.reset(); try { osmd.cursor.update(); } catch(e){} }
                },
                softReset: function() { this.clearTimers(); }
            };

            // === METRONOME SOUND ===
            function playClick(isStrong = false, isSubStrong = false) {
                if (!isMetroEnabled) return;
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = 'sine';
                let freq = 800;
                let volBoost = 1.0;
                if (isStrong) { freq = accentPitch; volBoost = accentRatio; } 
                else if (isSubStrong) { freq = 1100; volBoost = (accentRatio + 1.0) / 2; }
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                g.gain.setValueAtTime(0, audioCtx.currentTime);
                g.gain.linearRampToValueAtTime(masterVolume * 0.3 * volBoost, audioCtx.currentTime + 0.005);
                g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                osc.connect(g); g.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.06);
            }

            // === TEMPO LOGIC ===
            function updateTempoUI() {
                const currentBPM = Math.round(originalBPM * playbackSpeed);
                ui.rateSlider.value = playbackSpeed.toFixed(2);
                ui.rateDisplay.textContent = playbackSpeed.toFixed(2) + "x";
                ui.bpmSlider.min = Math.floor(originalBPM * 0.2); ui.bpmSlider.max = Math.floor(originalBPM * 2.0);
                ui.bpmSlider.value = currentBPM;
                ui.bpmDisplay.textContent = currentBPM; // UI Change
                ui.origBpmDisplay.textContent = "Ref: " + originalBPM; // UI Change
                ui.metroToggle.checked = isMetroEnabled;
                ui.countInToggle.checked = isCountInEnabled;
                ui.sigDisplay.textContent = `${currentBeatsPerMeasure}/${currentBeatType}`;
                ui.accentPitchSlider.value = accentPitch;
                ui.accentPitchDisplay.textContent = accentPitch + " Hz";
                ui.accentRatioSlider.value = accentRatio;
                ui.accentRatioDisplay.textContent = accentRatio.toFixed(1) + "x";
            }

            window.setSpeed = (newRate) => {
                if (playbackManager.isPlaying) {
                    const now = audioCtx.currentTime;
                    const elapsedAudio = now - playbackManager.audioAnchor;
                    const elapsedScore = elapsedAudio * playbackSpeed; 
                    const newStartOffset = playbackManager.scoreAnchor + elapsedScore;
                    playbackManager.softReset(); playbackSpeed = newRate; updateTempoUI();
                    playbackManager.play(lastParsedDoc, newStartOffset);
                } else { playbackSpeed = newRate; updateTempoUI(); }
            };
            window.setBPM = (targetBPM) => { const newRate = targetBPM / originalBPM; setSpeed(newRate); };
            ui.rateSlider.addEventListener('input', function() { setSpeed(parseFloat(this.value)); });
            ui.bpmSlider.addEventListener('input', function() { const target = parseInt(this.value); setSpeed(target / originalBPM); });
            window.adjustRate = (delta) => { let newRate = playbackSpeed + delta; if(newRate < 0.2) newRate = 0.2; if(newRate > 2.0) newRate = 2.0; setSpeed(newRate); };
            window.adjustBPM = (delta) => { const current = Math.round(originalBPM * playbackSpeed); setBPM(current + delta); };

            ui.metroToggle.addEventListener('change', function() { isMetroEnabled = this.checked; appSettings.metroOn = isMetroEnabled; saveSettings(); });
            ui.countInToggle.addEventListener('change', function() { isCountInEnabled = this.checked; appSettings.countInOn = isCountInEnabled; saveSettings(); });
            ui.accentPitchSlider.addEventListener('input', function() { accentPitch = parseInt(this.value); ui.accentPitchDisplay.textContent = accentPitch + " Hz"; appSettings.accentPitch = accentPitch; saveSettings(); });
            ui.accentRatioSlider.addEventListener('input', function() { accentRatio = parseFloat(this.value); ui.accentRatioDisplay.textContent = accentRatio.toFixed(1) + "x"; appSettings.accentRatio = accentRatio; saveSettings(); });

            function setupBPMPresets() {
                ui.bpmPresets.innerHTML = "";
                [0.5, 0.75, 1.0, 1.25, 1.5].forEach(r => {
                    const b = Math.round(originalBPM * r);
                    const btn = document.createElement('button');
                    btn.className = "pill"; btn.textContent = b; btn.onclick = () => setBPM(b); // UI Change to 'pill'
                    ui.bpmPresets.appendChild(btn);
                });
            }

            ui.btnLoad.onclick = () => ui.fileInput.click();
            ui.fileInput.onchange = async (e) => {
                const f = e.target.files[0]; if(!f) return;
                ui.btnLoad.style.color = "var(--neon-cyan)";
                try {
                    let xmlContent = "";
                    if (f.name.toLowerCase().endsWith('.mxl')) {
                        if (!window.JSZip) throw new Error("JSZip Missing");
                        const zip = await JSZip.loadAsync(f);
                        const container = await zip.file("META-INF/container.xml")?.async("string");
                        let rootPath = "";
                        if(container) {
                            const doc = new DOMParser().parseFromString(container, "text/xml");
                            rootPath = doc.querySelector("rootfile")?.getAttribute("full-path");
                        }
                        if(!rootPath) { for (let filename in zip.files) { if (filename.endsWith(".xml") && !filename.includes("META-INF")) { rootPath = filename; break; } } }
                        if(rootPath && zip.file(rootPath)) { xmlContent = await zip.file(rootPath).async("string"); } else { throw new Error("XML not found in MXL"); }
                    } else { xmlContent = await new Promise(r => { const fr = new FileReader(); fr.onload=e=>r(e.target.result); fr.readAsText(f); }); }
                    lastLoadedXML = xmlContent; lastParsedDoc = new DOMParser().parseFromString(xmlContent, "text/xml");
                    const beatsTag = lastParsedDoc.querySelector("beats"); const beatTypeTag = lastParsedDoc.querySelector("beat-type");
                    if (beatsTag) currentBeatsPerMeasure = parseInt(beatsTag.textContent); if (beatTypeTag) currentBeatType = parseInt(beatTypeTag.textContent);
                    let bpm = 120; const perMinTag = lastParsedDoc.querySelector("per-minute");
                    if (perMinTag) bpm = parseFloat(perMinTag.textContent); else { const soundTag = lastParsedDoc.querySelector("sound[tempo]"); if (soundTag) bpm = parseFloat(soundTag.getAttribute("tempo")); }
                    if (isNaN(bpm) || bpm <= 0) bpm = 120;
                    originalBPM = bpm; playbackSpeed = 1.0; setupBPMPresets(); updateTempoUI();
                    renderSheet(xmlContent); ui.btnPlay.disabled = false; ui.btnStop.disabled = false; playbackManager.stop();
                } catch(err) { alert("Load Failed: " + err.message); }
                ui.fileInput.value = '';
            };

            ui.btnPlay.onclick = () => { if (audioCtx.state === 'suspended') audioCtx.resume(); if (playbackManager.isPlaying) { playbackManager.pause(); } else { playbackManager.play(lastParsedDoc || lastLoadedXML); } };
            ui.btnStop.onclick = () => { playbackManager.stop(); };
            ui.btnView.onclick = () => { 
                isSheetMode = !isSheetMode; 
                if (isSheetMode) { 
                    ui.btnView.textContent = "üéº"; 
                    ui.mainStage.classList.add('sheet-active'); // UI Change class name
                } else { 
                    ui.btnView.textContent = "üëÅÔ∏è"; 
                    ui.mainStage.classList.remove('sheet-active'); 
                    if (!isRunning) document.getElementById('startOverlay').style.display = 'flex'; // UI Change
                } 
            };

            // === RECORDING (XML & WAV) ===
            let isRecording = false; let recordedNotes = []; let currentNoteEvent = null; let noteStartTime = 0;
            ui.btnRec.onclick = () => {
                isRecording = !isRecording;
                if (isRecording) { 
                    recordedNotes = []; currentNoteEvent = null; 
                    ui.btnRec.classList.add('recording'); 
                    // ui.btnRec.textContent = "‚óè REC (0)"; // Removed text change to keep icon clean
                    ui.btnExportXML.style.display = 'none'; ui.btnExportWAV.style.display = 'none';
                    // Start WAV Recording
                    if (mediaStream) {
                        audioChunks = [];
                        mediaRecorder = new MediaRecorder(mediaStream);
                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                        mediaRecorder.start();
                    }
                }
                else { 
                    if(currentNoteEvent) recordedNotes.push({...currentNoteEvent, duration: Date.now()-noteStartTime}); 
                    ui.btnRec.classList.remove('recording'); 
                    // ui.btnRec.textContent = "‚óè REC"; 
                    if(recordedNotes.length) ui.btnExportXML.style.display = 'inline-flex'; // UI Change flex
                    // Stop WAV Recording
                    if (mediaRecorder && mediaRecorder.state !== "inactive") {
                        mediaRecorder.stop();
                        mediaRecorder.onstop = () => {
                            wavBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            ui.btnExportWAV.style.display = 'inline-flex'; // UI Change flex
                        };
                    }
                }
            };
            function processRecording(detectedNote, detectedOctave) {
                const now = Date.now();
                if (!detectedNote) {
                    if (currentNoteEvent) { recordedNotes.push({...currentNoteEvent, duration: now - noteStartTime}); /* ui.btnRec.textContent = `‚óè REC (${recordedNotes.length})`; */ currentNoteEvent = null; }
                    return;
                }
                if (currentNoteEvent && detectedNote === currentNoteEvent.note && detectedOctave === currentNoteEvent.octave) return;
                if (currentNoteEvent) { recordedNotes.push({...currentNoteEvent, duration: now - noteStartTime}); /* ui.btnRec.textContent = `‚óè REC (${recordedNotes.length})`; */ }
                currentNoteEvent = {note: detectedNote, octave: detectedOctave}; noteStartTime = now;
            }
            ui.btnExportXML.onclick = () => {
                let x = `<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 4.0 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd"><score-partwise version="4.0"><part-list><score-part id="P1"><part-name>Rec</part-name></score-part></part-list><part id="P1"><measure number="1"><attributes><divisions>1000</divisions></attributes>`;
                recordedNotes.forEach(n=>{ let s=n.note[0], a=n.note.includes('#'); x+=`<note><pitch><step>${s}</step>${a?'<alter>1</alter>':''}<octave>${n.octave}</octave></pitch><duration>${n.duration}</duration><type>whole</type></note>`; });
                x+=`</measure></part></score-partwise>`;
                const blob = new Blob([x], { type: 'text/xml' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `rec_${Date.now()}.musicxml`; a.click();
            };
            ui.btnExportWAV.onclick = () => {
                if (!wavBlob) return;
                const a = document.createElement('a'); a.href = URL.createObjectURL(wavBlob); a.download = `recording_${Date.now()}.wav`; a.click();
            };

            function renderSheet(xml) {
                if (!opensheetmusicdisplay) return;
                if (!osmd) { osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer", { autoResize: true, backend: "svg", drawTitle: false, drawingParameters: "compacttight" }); }
                osmd.load(xml).then(function() { osmd.zoom = currentZoom; osmd.render(); if(osmd.cursor) osmd.cursor.show(); });
            }
            window.zoomOSMD = function(f) { if (!osmd) return; currentZoom *= f; osmd.zoom = currentZoom; osmd.render(); };

            function initTargetSelect(preset = []) {
                ui.targetSelect.innerHTML = "";
                // If preset is active, only show those notes
                const notesToShow = preset.length > 0 ? preset : Array.from({length: 84}, (_, i) => i + 24); // 24=C1 to 107=B7
                
                notesToShow.forEach(i => {
                    const noteName = notes[i % 12]; const oct = Math.floor(i / 12) - 1;
                    const opt = document.createElement('option'); opt.value = i; opt.text = `${noteName}${oct}`; ui.targetSelect.appendChild(opt);
                });
                
                if (preset.length > 0) {
                     appSettings.targetMode = true; ui.targetToggle.checked = true; ui.targetSelect.disabled = false;
                     // Set first note of preset as target
                     appSettings.targetNoteIndex = preset[0]; ui.targetSelect.value = preset[0];
                }
            }
            initTargetSelect(); // Init with chromatic

            ui.instPresetSelect.addEventListener('change', function() {
                const presetKey = this.value;
                appSettings.preset = presetKey;
                const presetNotes = tuningPresets[presetKey] || [];
                initTargetSelect(presetNotes);
                applyUI(); saveSettings();
            });
            
            function applyUI() {
                ui.a4Slider.value = appSettings.a4; ui.a4Display.innerText = appSettings.a4 + " Hz";
                ui.gateSlider.value = appSettings.gate; ui.gateDisplay.innerText = (appSettings.gate * 1000).toFixed(1);
                ui.smoothSlider.value = appSettings.smoothing; ui.smoothDisplay.innerText = Math.round(appSettings.smoothing * 100) + "%";
                ui.targetToggle.checked = appSettings.targetMode; ui.targetSelect.disabled = !appSettings.targetMode;
                ui.targetSelect.value = appSettings.targetNoteIndex;
                ui.instPresetSelect.value = appSettings.preset || 'chromatic';
                
                isMetroEnabled = appSettings.metroOn;
                isCountInEnabled = appSettings.countInOn;
                accentPitch = appSettings.accentPitch;
                accentRatio = appSettings.accentRatio;
                updateTempoUI();
                if(appSettings.targetMode) ui.appBody.classList.add('target-active'); else ui.appBody.classList.remove('target-active'); // UI class change
            }
            applyUI();

            ui.a4Slider.addEventListener('input', function() { appSettings.a4 = parseInt(this.value); ui.a4Display.innerText = appSettings.a4 + " Hz"; saveSettings(); });
            ui.gateSlider.addEventListener('input', function() { appSettings.gate = parseFloat(this.value); ui.gateDisplay.innerText = (appSettings.gate * 1000).toFixed(1); saveSettings(); });
            ui.smoothSlider.addEventListener('input', function() { appSettings.smoothing = parseFloat(this.value); ui.smoothDisplay.innerText = Math.round(appSettings.smoothing * 100) + "%"; saveSettings(); });
            ui.targetToggle.addEventListener('change', function() { appSettings.targetMode = this.checked; ui.targetSelect.disabled = !this.checked; if (this.checked) ui.appBody.classList.add('target-active'); else ui.appBody.classList.remove('target-active'); saveSettings(); });
            ui.targetSelect.addEventListener('change', function() { appSettings.targetNoteIndex = parseInt(this.value); saveSettings(); });
            
            const settingsModal = document.getElementById('settingsModal');
            const tempoModal = document.getElementById('tempoModal');
            document.getElementById('openSettings').onclick = () => settingsModal.style.display = 'block';
            document.getElementById('closeSettings').onclick = () => settingsModal.style.display = 'none';
            ui.btnTempo.onclick = () => tempoModal.style.display = 'block';
            document.getElementById('closeTempo').onclick = () => tempoModal.style.display = 'none';

            ui.startBtn.onclick = async function() {
                document.getElementById('startOverlay').style.display = 'none'; // UI Change
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
                    analyser = audioCtx.createAnalyser(); analyser.smoothingTimeConstant = 0.8;
                    gainNode = audioCtx.createGain(); gainNode.gain.value = 5.0; 
                    micSource = audioCtx.createMediaStreamSource(mediaStream); micSource.connect(gainNode); gainNode.connect(analyser); 
                    setMode('turbo'); isRunning = true; update();
                } catch (e) { alert("Mic Error: " + e.message); document.getElementById('startOverlay').style.display = 'flex'; }
            };

            function playMusicXML(input, startOffset = 0) {
                let doc = input;
                if (typeof input === "string") doc = new DOMParser().parseFromString(input, "text/xml");
                if (doc.querySelector("parsererror")) { alert("XML Parsing Error"); ui.btnPlay.textContent = "‚ñ∂"; return; }

                let divisions = 480;
                const divTag = doc.querySelector("divisions");
                if (divTag) { const val = parseFloat(divTag.textContent); if (!isNaN(val) && val > 0) divisions = val; }

                let bpm = originalBPM; 
                const effectiveBPM = bpm * playbackSpeed;
                const isLegacy = (divisions === 1000 && !doc.querySelector("per-minute") && !doc.querySelector("sound"));

                let secPerBeat = (divisions / divisions) * (60 / bpm);
                if (currentBeatType === 8) secPerBeat *= 0.5;

                let currentBeatScore = Math.floor(startOffset / secPerBeat) * secPerBeat;
                
                while (currentBeatScore < startOffset + 200) { 
                    if (currentBeatScore >= startOffset) {
                        const delayRealTime = (currentBeatScore - startOffset) / playbackSpeed;
                        const beatIndex = Math.round(currentBeatScore / secPerBeat);
                        let isStrong = false; let isSubStrong = false;
                        if (currentBeatsPerMeasure === 4) { isStrong = (beatIndex % 4 === 0); isSubStrong = (beatIndex % 4 === 2); } 
                        else if (currentBeatsPerMeasure === 3) { isStrong = (beatIndex % 3 === 0); } 
                        else if (currentBeatsPerMeasure === 6 && currentBeatType === 8) { isStrong = (beatIndex % 6 === 0); isSubStrong = (beatIndex % 6 === 3); } 
                        else { isStrong = (beatIndex % currentBeatsPerMeasure === 0); }
                        const clickId = setTimeout(() => { if (playbackManager.isPlaying) playClick(isStrong, isSubStrong); }, (audioCtx.currentTime + 0.1 + delayRealTime - audioCtx.currentTime) * 1000);
                        playbackManager.timeouts.push(clickId);
                    }
                    currentBeatScore += secPerBeat;
                }

                const parts = doc.querySelectorAll("part");
                let maxGlobalTime = 0;
                const startTimeRef = audioCtx.currentTime + 0.1;

                parts.forEach((part, partIndex) => {
                    let currentTime = 0;
                    const rawMeasures = Array.from(part.querySelectorAll("measure"));
                    const playList = [];
                    let repeatStartIndex = 0;
                    for (let i = 0; i < rawMeasures.length; i++) {
                        const m = rawMeasures[i];
                        const repeatStart = m.querySelector("repeat[direction='forward']");
                        if (repeatStart) repeatStartIndex = i;
                        playList.push({ measure: m, index: i });
                        const repeatEnd = m.querySelector("repeat[direction='backward']");
                        if (repeatEnd) { for (let r = repeatStartIndex; r <= i; r++) playList.push({ measure: rawMeasures[r], index: r }); repeatStartIndex = i + 1; }
                    }
                    playList.forEach(item => {
                        const measure = item.measure; const measureIndex = item.index;
                        const children = Array.from(measure.childNodes).filter(n => n.nodeType === 1);
                        let measureCursor = 0;
                        children.forEach(node => {
                            if (node.tagName === "note") {
                                const isRest = node.querySelector("rest") !== null;
                                const isChord = node.querySelector("chord") !== null;
                                const durNode = node.querySelector("duration");
                                let durationScoreSec = 0.05;
                                if(durNode) { let d = parseFloat(durNode.textContent); if(isLegacy) durationScoreSec = d/1000; else durationScoreSec = (d/divisions)*(60/bpm); }
                                if(durationScoreSec<0.05) durationScoreSec=0.05;
                                let noteStartScore = currentTime + measureCursor;
                                if (isChord) noteStartScore = window.lastNoteStart || noteStartScore; else { window.lastNoteStart = noteStartScore; measureCursor += durationScoreSec; }
                                if (noteStartScore >= startOffset) {
                                    const delayRealTime = (noteStartScore - startOffset) / playbackSpeed;
                                    const durationRealTime = durationScoreSec / playbackSpeed;
                                    if (!isChord && partIndex === 0) {
                                        const cursorId = setTimeout(() => { if (playbackManager.isPlaying && osmd && osmd.cursor) { try { if (osmd.cursor.iterator.currentMeasureIndex !== measureIndex) { osmd.cursor.resetIteratorToMeasure(measureIndex, 0); } else { osmd.cursor.next(); } if (isSheetMode) osmd.cursor.cursorElement.scrollIntoView({behavior: "auto", block: "center"}); } catch(e){} } }, (startTimeRef + delayRealTime - audioCtx.currentTime) * 1000);
                                        playbackManager.timeouts.push(cursorId);
                                    }
                                    if (!isRest) {
                                        const step = node.querySelector("step")?.textContent; const oct = node.querySelector("octave")?.textContent; const alt = node.querySelector("alter")?.textContent;
                                        if (step && oct) {
                                            let nn = step + (alt==="1"?"#":"");
                                            if(alt==="-1") { const map={"D":"C#","E":"D#","G":"F#","A":"G#","B":"A#"}; if(map[step]) nn=map[step]; }
                                            const f = appSettings.a4 * Math.pow(2, ((parseInt(oct)+1)*12 + ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(nn)-69)/12);
                                            const t1 = setTimeout(() => {
                                                if(!playbackManager.isPlaying) return;
                                                const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
                                                osc.frequency.value = f; g.gain.setValueAtTime(0, audioCtx.currentTime);
                                                g.gain.linearRampToValueAtTime(masterVolume*0.3, audioCtx.currentTime+0.02);
                                                g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+durationRealTime);
                                                osc.connect(g); g.connect(audioCtx.destination); osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime+durationRealTime);
                                                const k = document.querySelector(`.key[data-note="${nn}"]`); if(k) k.classList.add('pressed');
                                            }, (startTimeRef + delayRealTime - audioCtx.currentTime) * 1000);
                                            const t2 = setTimeout(() => {
                                                if(!playbackManager.isPlaying) return;
                                                const k = document.querySelector(`.key[data-note="${nn}"]`); if(k) k.classList.remove('pressed');
                                            }, (startTimeRef + delayRealTime + durationRealTime - audioCtx.currentTime) * 1000);
                                            playbackManager.timeouts.push(t1, t2);
                                        }
                                    }
                                } 
                                maxGlobalTime = Math.max(maxGlobalTime, noteStartScore + durationScoreSec);
                            } 
                            else if (node.tagName === "backup") { const d = parseFloat(node.querySelector("duration")?.textContent||0); if(isLegacy) measureCursor -= d/1000; else measureCursor -= (d/divisions)*(60/bpm); }
                            else if (node.tagName === "forward") { const d = parseFloat(node.querySelector("duration")?.textContent||0); if(isLegacy) measureCursor += d/1000; else measureCursor += (d/divisions)*(60/bpm); }
                        });
                        currentTime += Math.max(measureCursor, 0); 
                    });
                });
                const remainingRealTime = (maxGlobalTime - startOffset) / playbackSpeed;
                const finishId = setTimeout(() => { playbackManager.stop(); }, (startTimeRef + remainingRealTime - audioCtx.currentTime) * 1000 + 500);
                playbackManager.timeouts.push(finishId);
            }

            function update() {
                if(!isRunning) return; analyser.getFloatTimeDomainData(dataArray);
                let sum=0; for(let i=0;i<dataArray.length;i+=4) sum+=dataArray[i]*dataArray[i];
                const rms = Math.sqrt(sum/(dataArray.length/4));
                let cents = null; let hasSignal = false;
                let recNote = null; let recOct = null;

                if(rms > appSettings.gate) {
                    const p = detectPitch(dataArray, audioCtx.sampleRate);
                    if(p!==-1 && p>25 && p<4200) {
                        hasSignal = true;
                        const noteFloat = 12 * (Math.log(p/appSettings.a4)/Math.log(2));
                        let rNote = Math.round(noteFloat)+69;
                        if(appSettings.targetMode) rNote = appSettings.targetNoteIndex;
                        const dNote = notes[rNote%12]; const dOct = Math.floor(rNote/12)-1;
                        const fNote = appSettings.a4 * Math.pow(2, (rNote-69)/12);
                        const rCents = Math.floor(1200 * Math.log(p/fNote)/Math.log(2));
                        recNote = dNote; recOct = dOct;
                        smoothedCents = (smoothedCents*appSettings.smoothing) + (rCents*(1-appSettings.smoothing));
                        cents = smoothedCents; lastValidCents = cents; framesSinceLastSignal = 0; currentCents = cents; isSignalActive = true;
                        ui.hz.textContent = p.toFixed(1); ui.cents.textContent = (cents>0?"+":"")+cents.toFixed(0);
                        if(lastNoteName !== dNote+dOct) {
                            ui.note.textContent = dNote; ui.oct.textContent = dOct; lastNoteName = dNote+dOct;
                            ui.keys.forEach(k=>k.classList.remove('active'));
                            const k=document.querySelector(`.key[data-note="${dNote}"]`); if(k) k.classList.add('active');
                        }
                    }
                }
                if(!hasSignal) { framesSinceLastSignal++; if(framesSinceLastSignal<SIGNAL_HOLD_FRAMES) { cents = lastValidCents; isSignalActive = true; } else { isSignalActive = false; cents = null; } }
                if(isRecording) processRecording(recNote, recOct);
                pitchHistory.pop(); pitchHistory.unshift(cents);
                drawVisualizer(); requestAnimationFrame(update);
            }

            function drawVisualizer() {
                if (isSheetMode) return;
                const w = canvas.parentElement.clientWidth; const h = canvas.parentElement.clientHeight; canvas.width = w; canvas.height = h;
                const isLocked = isSignalActive && currentCents !== null && Math.abs(currentCents) <= 5;
                if (isLocked) { ctx.fillStyle = "#66cc66"; ctx.fillRect(0, 0, w, h); ctx.strokeStyle = "rgba(255,255,255,0.8)"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h); ctx.stroke(); } 
                else {
                    const centerW = w * 0.15; ctx.fillStyle = "#ff5252"; ctx.fillRect(0, 0, w/2 - centerW/2, h); ctx.fillStyle = "#66cc66"; ctx.fillRect(w/2 - centerW/2, 0, centerW, h); ctx.fillStyle = "#ff5252"; ctx.fillRect(w/2 + centerW/2, 0, w, h); ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h); ctx.stroke();
                }
                ctx.strokeStyle = "#ffffff"; ctx.lineWidth = 4; ctx.lineCap = "round"; ctx.lineJoin = "round"; ctx.beginPath();
                const rowH = h / historySize; let lastX = null;
                for (let i = 0; i < historySize; i++) {
                    if (pitchHistory[i] !== null) {
                        const val = Math.max(-50, Math.min(50, pitchHistory[i])); const x = (val + 50) / 100 * w; const y = i * rowH;
                        if (lastX === null) ctx.moveTo(x, y); else if (Math.abs(x - lastX) < w * 0.8) ctx.lineTo(x, y); else ctx.moveTo(x, y);
                        lastX = x;
                    } else lastX = null;
                }
                ctx.stroke();
            }

            function detectPitch(buffer, sampleRate) {
                const threshold = 0.15; const halfSize = Math.floor(buffer.length / 2); const yinBuffer = new Float32Array(halfSize);
                for (let t = 0; t < halfSize; t++) { let sum = 0; for (let i = 0; i < halfSize; i += downsampleStep) { const d = buffer[i] - buffer[i + t]; sum += d * d; } yinBuffer[t] = sum; }
                yinBuffer[0] = 1; let runningSum = 0; for (let t = 1; t < halfSize; t++) { runningSum += yinBuffer[t]; yinBuffer[t] *= t / runningSum; }
                let tau = -1; for (let t = 2; t < halfSize; t++) { if (yinBuffer[t] < threshold) { while (t + 1 < halfSize && yinBuffer[t + 1] < yinBuffer[t]) t++; tau = t; break; } }
                if (tau === -1) return -1; const x0 = yinBuffer[tau - 1], x2 = yinBuffer[tau + 1], x1 = yinBuffer[tau];
                return sampleRate / (tau + (x2 - x0) / (2 * (2 * x1 - x2 - x0)));
            }
            
            window.setMode = (mode) => { if (mode === 'turbo') { currentFFTSize = 2048; downsampleStep = 2; document.getElementById('modeTurbo').className = 'pill active'; document.getElementById('modeBass').className = 'pill'; } else { currentFFTSize = 4096; downsampleStep = 2; document.getElementById('modeTurbo').className = 'pill'; document.getElementById('modeBass').className = 'pill active'; } if (analyser) { analyser.fftSize = currentFFTSize; dataArray = new Float32Array(analyser.fftSize); } };
            
            function startTone(noteName, octaveOverride = null) { 
                if (audioCtx.state === 'suspended') audioCtx.resume(); 
                const semitones = notes.indexOf(noteName); 
                const oct = octaveOverride !== null ? octaveOverride : keyboardOctave;
                const noteNum = (oct + 1) * 12 + semitones; 
                const freq = appSettings.a4 * Math.pow(2, (noteNum - 69) / 12); 
                if (toneOsc) stopTone(); 
                toneOsc = audioCtx.createOscillator(); toneGain = audioCtx.createGain(); 
                toneOsc.type = 'sine'; toneOsc.frequency.setValueAtTime(freq, audioCtx.currentTime); 
                toneGain.gain.setValueAtTime(0, audioCtx.currentTime); 
                toneGain.gain.linearRampToValueAtTime(masterVolume, audioCtx.currentTime + 0.05); 
                toneGain.connect(audioCtx.destination); if (analyser) toneGain.connect(analyser); 
                toneOsc.connect(toneGain); toneOsc.start(); 
            }
            function stopTone() { if (toneOsc && toneGain) { const stopTime = audioCtx.currentTime + 0.1; toneGain.gain.cancelScheduledValues(audioCtx.currentTime); toneGain.gain.setValueAtTime(toneGain.gain.value, audioCtx.currentTime); toneGain.gain.linearRampToValueAtTime(0, stopTime); toneOsc.stop(stopTime); const oldOsc = toneOsc; const oldGain = toneGain; setTimeout(() => { oldOsc.disconnect(); oldGain.disconnect(); }, 200); toneOsc = null; toneGain = null; } }
            
            function stopMic() { if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); mediaStream = null; } isRunning = false; if (!isSheetMode) { document.getElementById('startOverlay').style.display = 'flex'; /* ui.startBtn.innerText = "‚ö° Resume"; */ } }
            document.addEventListener('visibilitychange', () => { if (document.hidden) { stopMic(); playbackManager.pause(); } });

            ui.keys.forEach(key => {
                const note = key.getAttribute('data-note');
                const press = (e) => { e.preventDefault(); key.classList.add('pressed'); startTone(note); };
                const release = (e) => { e.preventDefault(); key.classList.remove('pressed'); stopTone(); };
                key.addEventListener('mousedown', press); key.addEventListener('mouseup', release); key.addEventListener('mouseleave', release); key.addEventListener('touchstart', press); key.addEventListener('touchend', release);
            });
            ui.volSlider.addEventListener('input', function() { masterVolume = parseFloat(this.value); ui.volDisplay.textContent = Math.round(masterVolume * 100) + "%"; if (toneGain) toneGain.gain.setTargetAtTime(masterVolume, audioCtx.currentTime, 0.1); });
            ui.octavePills.forEach(pill => { pill.addEventListener('click', function() { ui.octavePills.forEach(p => p.classList.remove('active')); this.classList.add('active'); keyboardOctave = parseInt(this.getAttribute('data-oct')); this.scrollIntoView({behavior: "smooth", block: "nearest", inline: "center"}); }); });
        });
    </script>
</body>
</html>
